{
  "version": 3,
  "sources": ["../../../src/lib/classes/data-item.ts"],
  "sourcesContent": ["import * as Color from '../const/Color';\nimport { BaseClass } from './library';\nimport { BaseClassTriggerd, StatesControler } from '../controller/states-controller';\nimport * as NSPanel from '../types/types';\n\nexport class Dataitem extends BaseClass {\n    options: NSPanel.DataItemsOptions;\n    //private obj: ioBroker.Object | null | undefined;\n    stateDB: StatesControler;\n    type: ioBroker.CommonType | 'undefined' | undefined = undefined;\n    parent: BaseClassTriggerd;\n    /**\n     * Call isValidAndInit() after constructor and check return value - if false, this object is not configured correctly.\n     * @param adapter this of adapter\n     * @param options {NSPanel.DataItemsOptions}\n     * @param parent {BaseClassTriggerd}\n     * @param db {StatesControler}\n     */\n    constructor(adapter: any, options: NSPanel.DataItemsOptions, parent: BaseClassTriggerd, db: StatesControler) {\n        super(adapter, options.name || '');\n        this.options = options;\n        this.options.type = options.type;\n        this.stateDB = db;\n        this.parent = parent;\n        switch (this.options.type) {\n            case 'const':\n                /*if (!this.options.constVal) {\n                    this.log.error(`Error 1001 in constructor val == '' not allow in type const!`);\n                }*/\n                this.setTypeFromValue(this.options.constVal);\n                this.options.state = {\n                    val: this.options.constVal,\n                    ack: true,\n                    ts: Date.now(),\n                    lc: Date.now(),\n                    from: '',\n                };\n                break;\n            case 'state':\n            case 'triggered':\n                this.type = this.options.forceType ? this.options.forceType : undefined;\n                // all work is done in isValidAndInit\n                break;\n        }\n    }\n\n    /**\n     * Init and check dp is valid\n     * @returns if false value is not valid\n     */\n    async isValidAndInit(): Promise<boolean> {\n        switch (this.options.type) {\n            case 'const':\n                return this.options.constVal !== undefined;\n            case 'state':\n            case 'triggered':\n                if (this.options.dp === undefined || this.options.dp === '') return false;\n                const obj = await this.adapter.getForeignObjectAsync(this.options.dp);\n                if (!obj || obj.type != 'state' || !obj.common) {\n                    this.log.warn(`801: ${this.options.dp} has a invalid state object!`);\n                    return false;\n                    //throw new Error(`801: ${this.options.dp} has no state object! Bye Bye`);\n                }\n                this.type = this.type || obj.common.type;\n                this.options.role = obj.common.role;\n                if (this.options.type == 'triggered')\n                    this.stateDB.setTrigger(this.options.dp, this.parent, this.options.response);\n                const value = await this.stateDB.getState(this.options.dp, this.options.response);\n                return !!value;\n        }\n        return false;\n    }\n    private async getRawState(): Promise<NSPanel.State | null | undefined> {\n        switch (this.options.type) {\n            case 'const':\n                return this.options.state;\n            case 'state':\n            case 'triggered':\n                if (!this.options.dp) {\n                    throw new Error(`Error 1002 type is ${this.options.type} but dp is undefined`);\n                }\n                return await this.stateDB.getState(this.options.dp, this.options.response);\n            case 'internal': {\n            }\n        }\n        return null;\n    }\n    async getState(): Promise<NSPanel.State | null | undefined> {\n        let state = await this.getRawState();\n        if (state) {\n            state = { ...state };\n            if (this.options.type !== 'const' && this.options.type !== 'internal' && this.options.read) {\n                try {\n                    if (typeof this.options.read === 'string')\n                        state.val = new Function('val', 'Color', `${this.options.read}`)(state.val, Color);\n                    else state.val = this.options.read(state.val);\n                    this.log.debug(JSON.stringify(state.val));\n                } catch (e) {\n                    this.log.error(`Read is invalid: ${this.options.read} Error: ${e}`);\n                }\n            }\n        }\n        return state;\n    }\n\n    async getObject(): Promise<object | null> {\n        const state = await this.getState();\n        if (state && state.val) {\n            if (typeof state.val === 'string') {\n                try {\n                    const value = JSON.parse(state.val);\n                    return value;\n                } catch (e) {\n                    this.log.warn('Read a incorrect json!');\n                }\n            } else if (typeof state.val === 'object') {\n                return state.val;\n            }\n        }\n        return null;\n    }\n\n    async getRGBValue(): Promise<NSPanel.RGB | null> {\n        const value = await this.getObject();\n        if (value) {\n            if (NSPanel.isRGB(value)) return value;\n        }\n        return null;\n    }\n    async getIconScale(): Promise<NSPanel.IconScaleElement | null> {\n        const value = await this.getObject();\n        if (value) {\n            if (NSPanel.isIconScaleElement(value)) return value;\n        }\n        return null;\n    }\n    async getRGBDec(): Promise<string | null> {\n        const value = await this.getRGBValue();\n        if (value) {\n            return String(Color.rgb_dec565(value));\n        }\n        return null;\n    }\n    async getString(): Promise<string | null> {\n        const state = await this.getState();\n        switch (this.options.type) {\n            case 'const':\n                return state && state.val !== null ? String(state.val) : null;\n            case 'state':\n            case 'triggered':\n                if (this.options.substring) {\n                    const args = this.options.substring;\n                    return state && state.val !== null ? String(state.val).substring(args[0], args[1]) : null;\n                }\n                return state && state.val !== null ? String(state.val) : null;\n        }\n        return null;\n    }\n\n    async getNumber(): Promise<number | null> {\n        const result = await this.getState();\n        if (result && !isNaN(parseInt(String(result.val)))) {\n            return parseFloat(result.val as string);\n        }\n        return null;\n    }\n    async getBoolean(): Promise<boolean | null> {\n        const result = await this.getState();\n        if (result && result.val !== null) {\n            if (typeof result.val === 'string') {\n                switch (result.val.toLowerCase()) {\n                    case 'ok':\n                    case 'on':\n                    case 'yes':\n                    case 'true':\n                    case 'online':\n                        return true;\n                }\n            }\n            return !!result.val;\n        }\n        return null;\n    }\n\n    private setTypeFromValue(val: NSPanel.StateValue | undefined): void {\n        switch (typeof val) {\n            case 'string':\n                this.type = 'string';\n                break;\n            case 'number':\n            case 'bigint':\n                this.type = 'number';\n                break;\n            case 'boolean':\n                this.type = 'boolean';\n                break;\n            case 'undefined':\n                this.type = 'undefined';\n            case 'symbol':\n            case 'object':\n            case 'function':\n                this.type = 'object';\n        }\n    }\n    async setStateTrue(): Promise<void> {\n        await this.setStateAsync(true);\n    }\n    async setStateFalse(): Promise<void> {\n        await this.setStateAsync(false);\n    }\n    /**\n     * Flip this 'ON'/'OFF', 0/1 or true/false. Depend on this.type\n     */\n    async setStateFlip(): Promise<void> {\n        switch (this.type) {\n            case 'boolean':\n                await this.setStateAsync(!(await this.getBoolean()));\n                break;\n            case 'number':\n                await this.setStateAsync((await this.getBoolean()) ? 0 : 1);\n                break;\n            case 'string':\n                await this.setStateAsync((await this.getBoolean()) ? 'OFF' : 'ON');\n                break;\n        }\n    }\n    /**\n     * Set a internal, const or external State\n     * @param val number | boolean | string | null\n     * @returns\n     */\n    async setStateAsync(val: ioBroker.StateValue): Promise<void> {\n        if (val === undefined) return;\n        if (this.options.type === 'const') {\n            this.options.constVal = val;\n        } else {\n            await this.stateDB.setStateAsync(this, val);\n        }\n    }\n}\n\nexport function isDataItem(F: object | Dataitem): F is Dataitem {\n    if (F instanceof Dataitem) return true;\n    return false;\n}\n"],
  "mappings": "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",
  "names": []
}
