{
  "version": 3,
  "sources": ["../../../src/lib/classes/system-notifications.ts"],
  "sourcesContent": ["import { insertLinebreak } from '../const/tools';\nimport type { GetNotificationsResponse, HostId, notification } from '../types/system-notifications';\nimport { BaseClass, type AdapterClassDefinition } from './library';\n\nexport class SystemNotifications extends BaseClass {\n    private language: ioBroker.Languages;\n    private notifications: notification[] = [];\n    private messageTimeout: ioBroker.Timeout | undefined;\n    private count: number = 0;\n\n    constructor(adapter: AdapterClassDefinition) {\n        super(adapter, 'system-notifications');\n        this.language = this.adapter.library.getLocalLanguage();\n    }\n    public async init(): Promise<void> {\n        await this.adapter.subscribeForeignStatesAsync('system.host.*.notifications.*');\n        const obj = await this.adapter.getObjectAsync(`${this.adapter.namespace}.panels`);\n        if (obj) {\n            this.notifications = (obj.native && obj.native.SystemNotifications) || [];\n        }\n        if (this.adapter.config.testCase) {\n            return;\n        }\n        await this.handleIobrokerNotifications();\n    }\n    async delete(): Promise<void> {\n        await this.writeConfig();\n        await super.delete();\n        if (this.messageTimeout) {\n            this.adapter.clearTimeout(this.messageTimeout);\n        }\n        this.messageTimeout = undefined;\n    }\n    /**\n     * write config data to object\n     */\n    private async writeConfig(): Promise<void> {\n        const obj = await this.adapter.getObjectAsync(`${this.adapter.namespace}.panels`);\n        if (obj && obj.native) {\n            obj.native.SystemNotifications = this.notifications;\n            await this.adapter.setObjectAsync(`${this.adapter.namespace}.panels`, obj);\n        }\n    }\n\n    /**\n     * Get all existing hosts of this installation.\n     */\n    private async getAllHosts(): Promise<HostId[]> {\n        const res = await this.adapter.getObjectViewAsync('system', 'host', {\n            startkey: 'system.host.',\n            endkey: 'system.host.\\u9999',\n        });\n\n        return res.rows.map(host => host.id);\n    }\n    /**\n     * Is called if a subscribed state changes\n     *\n     * @param id    The id of the state that changed\n     * @param _state The state object holding the new value and meta information of the state\n     */\n    public async onStateChange(id: string, _state: ioBroker.State | null | undefined): Promise<void> {\n        if (id.startsWith('system.host')) {\n            const hostName = id.split('.')[2];\n            this.log.info(`New notification on \"${hostName}\" detected`);\n            await this.handleIobrokerNotifications([`system.host.${hostName}`]);\n        }\n    }\n    /**\n     * Checks for existing notifications and handles them according to the configuration\n     *\n     * @param hosts names of the hosts to handle notifications for, if omitted all hosts are used\n     */\n    private async handleIobrokerNotifications(hosts?: HostId[]): Promise<void> {\n        hosts = hosts || (await this.getAllHosts());\n\n        for (const host of hosts) {\n            this.log.debug(`Request notifications from \"${host}\"`);\n\n            const _helper = async (): Promise<GetNotificationsResponse> => {\n                return new Promise(resolve => {\n                    setTimeout(() => {\n                        resolve({ result: {} });\n                    }, 1000);\n                    return resolve(\n                        this.adapter.sendToHostAsync(\n                            host,\n                            'getNotifications',\n                            {},\n                        ) as unknown as GetNotificationsResponse,\n                    );\n                });\n            };\n            const { result: notifications } = await _helper();\n\n            this.log.debug(`Received notifications from \"${host}\": ${JSON.stringify(notifications)}`);\n\n            const msgs: notification[] = [];\n            for (const k in notifications) {\n                const sub = notifications[k];\n                for (const c in sub.categories) {\n                    msgs.push({\n                        id: `${k}.${c}`,\n                        headline: (hosts.length > 1 ? `${host}: ` : '') + sub.categories[c].name[this.language],\n                        text: sub.categories[c].description[this.language],\n                        version: 0,\n                        severity: sub.categories[c].severity,\n                        ts: 0,\n                        cleared: false,\n                        scopeid: k,\n                        categoryid: c,\n                        host: host,\n                    });\n                }\n            }\n            this.notifications = this.notifications.filter(a => {\n                if (!a.scopeid || !a.categoryid || a.host !== host) {\n                    return true;\n                }\n                return msgs.findIndex(b => b.scopeid === a.scopeid && b.categoryid === a.categoryid) !== -1;\n            });\n            for (const m of msgs) {\n                await this.sendNotifications(m);\n            }\n        }\n    }\n\n    private async sendNotifications(notify: notification): Promise<void> {\n        if (\n            this.notifications.some(a => {\n                if (\n                    (!a.scopeid && a.id === notify.id && a.ts === notify.ts && a.severity == notify.severity) ||\n                    (a.scopeid &&\n                        a.scopeid === notify.scopeid &&\n                        a.categoryid === notify.scopeid &&\n                        a.host === notify.host)\n                ) {\n                    return true;\n                }\n            })\n        ) {\n            return;\n        }\n        this.notifications.push(notify);\n\n        if (this.messageTimeout) {\n            return;\n        }\n        this.messageTimeout = this.adapter.setTimeout(async () => {\n            this.notifications.sort((a, b) => {\n                if (a.severity === b.severity) {\n                    return 0;\n                }\n                if (a.severity === 'alert') {\n                    return 1;\n                }\n                if (b.severity === 'alert') {\n                    return -1;\n                }\n                return 0;\n            });\n            this.count = this.notifications.filter(a => !a.cleared).length;\n            if (this.notifications.some(a => !a.cleared)) {\n                this.adapter.controller && (await this.adapter.controller.notificationToPanel());\n            }\n        }, 2500);\n    }\n\n    /**\n     * Clear a notification\n     *\n     * @param index index of the notification\n     */\n    public async clearNotification(index: number): Promise<void> {\n        if (this.notifications[index] && !this.notifications[index].cleared) {\n            if (this.notifications[index].scopeid) {\n                const msg = this.notifications[index];\n                if (msg.host) {\n                    try {\n                        await this.adapter.sendToHostAsync(msg.host, 'clearNotifications', {\n                            scopeFilter: msg.scopeid ?? null,\n                            categoryFilter: msg.categoryid ?? null,\n                        });\n                    } catch {\n                        this.log.error('Error while clear notification');\n                    }\n                }\n            }\n            if (this.notifications[index]) {\n                this.notifications[index].cleared = true;\n            }\n            await this.writeConfig();\n        }\n    }\n    public getNotification(index: number): { headline: string; text: string } | null {\n        if (this.notifications[index]) {\n            let currentNotify = 0;\n            this.notifications.forEach(a => !a.cleared && currentNotify <= index && currentNotify++);\n            const { headline, text } = this.notifications[index];\n            const line = 46;\n            return {\n                headline: `${this.library.getTranslation('Notification')} (${currentNotify}/${this.count})`,\n                text: `${insertLinebreak(headline, line)}\\n${insertLinebreak(text, line)}`,\n            };\n        }\n        return null;\n    }\n    /**\n     * Get the index of the next notification\n     *\n     * @param index index of the notification\n     */\n    public getNotificationIndex(index: number): number {\n        if (index === -1) {\n            index = 0;\n        }\n        const l = this.notifications.length;\n        if (index >= 0) {\n            for (index; index < l; index++) {\n                if (this.notifications[index] && !this.notifications[index].cleared) {\n                    break;\n                }\n            }\n            if (this.notifications[index] && !this.notifications[index].cleared) {\n                return index;\n            }\n        }\n        return -1;\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
