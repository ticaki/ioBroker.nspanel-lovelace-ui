{
  "version": 3,
  "sources": ["../../../src/lib/controller/panel-message.ts"],
  "sourcesContent": ["import type { IClientPublishOptions } from 'mqtt';\nimport { SendTopicAppendix } from '../const/definition';\nimport { BaseClass, type AdapterClassDefinition } from './library';\nimport type { MQTTClientClass, callbackMessageType } from '../classes/mqtt';\nimport type { Panel } from './panel';\n\n/**\n * \u00DCbernimmt das senden von Payloads an die mqtt Klasse - delay zwischen einzelnen Messages\n * 1 * pro Klasse Panel\n */\nexport class PanelSend extends BaseClass {\n    private messageDb: { payload: string; opt?: IClientPublishOptions; ackForType: boolean }[] = [];\n    private messageDbTasmota: { topic: string; payload: string; opt?: IClientPublishOptions }[] = [];\n\n    private messageTimeout: ioBroker.Timeout | undefined;\n    private messageTimeoutTasmota: ioBroker.Timeout | true | undefined;\n    private mqttClient: MQTTClientClass;\n    private topic: string = '';\n    private configTopic: string = '';\n    private losingMessageCount = 0;\n\n    private _losingDelay = 1000;\n    panel: Panel | undefined = undefined;\n\n    get losingDelay(): number {\n        return this._losingDelay;\n    }\n    set losingDelay(v: number) {\n        this._losingDelay = Math.max(1000, Math.min(30_000, v));\n    }\n    constructor(\n        adapter: AdapterClassDefinition,\n        config: { name: string; mqttClient: MQTTClientClass; topic: string; panel: Panel },\n    ) {\n        super(adapter, config.name);\n        this.mqttClient = config.mqttClient;\n        void this.mqttClient.subscribe(`${config.topic}/stat/RESULT`, this.onMessage);\n        this.configTopic = config.topic;\n        this.topic = config.topic + SendTopicAppendix;\n        this.panel = config.panel;\n    }\n\n    public resetMessageDB(): void {\n        this.messageDb = [];\n        if (this.messageTimeout) {\n            this.adapter.clearTimeout(this.messageTimeout);\n        }\n        this.messageTimeout = undefined;\n        this.losingMessageCount = 0;\n        this._losingDelay = 1000;\n    }\n    onMessage: callbackMessageType = async (topic: string, message: string) => {\n        if (this.unload || this.adapter.unload) {\n            return;\n        }\n        if (!topic.endsWith('/stat/RESULT')) {\n            return;\n        }\n        if (this.adapter.config.debugLogMqtt) {\n            this.log.debug(`Receive command ${topic} with ${message}`);\n        }\n        try {\n            const msg = JSON.parse(message);\n            const ackForType = this.messageDb[0] && this.messageDb[0].ackForType;\n            if (msg) {\n                if (\n                    (ackForType && msg.CustomSend === 'renderCurrentPage') ||\n                    (!ackForType && msg.CustomSend === 'Done')\n                ) {\n                    if (this.messageTimeout) {\n                        this.adapter.clearTimeout(this.messageTimeout);\n                    }\n                    this.losingMessageCount = 0;\n                    this._losingDelay = 1000;\n                    const oldMessage = this.messageDb.shift();\n                    if (oldMessage) {\n                        if (oldMessage.payload === 'pageType~pageStartup') {\n                            this.messageDb = [];\n                        }\n                        if (this.adapter.config.debugLogMqtt) {\n                            this.log.debug(`Receive ack for ${JSON.stringify(oldMessage)}`);\n                        }\n                    }\n\n                    this.messageTimeout = this.adapter.setTimeout(this.sendMessageLoop, 100);\n                } else {\n                    if (this.adapter.config.additionalLog) {\n                        this.log.info(\n                            `1: ${!(ackForType && msg.CustomSend === 'renderCurrentPage')} 2: ${!(!ackForType && msg.CustomSend === 'Done')} msg: ${msg.CustomSend}`,\n                        );\n                    }\n                }\n            }\n        } catch (err: any) {\n            this.log.error(`onMessage: ${err}`);\n        }\n    };\n\n    readonly addMessage = (\n        payload: string,\n        ackForType: boolean,\n        force?: boolean,\n        opt?: IClientPublishOptions,\n    ): void => {\n        if (\n            this.messageTimeout !== undefined &&\n            this.messageDb.length > 0 &&\n            this.messageDb.some(a => a.payload === payload && a.opt === opt)\n        ) {\n            if (this.adapter.config.debugLogMqtt) {\n                this.log.debug(`Message ${payload} is already in queue - skip adding`);\n            }\n            return;\n        }\n        if (!this.panel?.isOnline && force !== true) {\n            if (this.adapter.config.debugLogMqtt) {\n                this.log.debug(`Panel is offline - skip adding message ${payload}`);\n            }\n            return;\n        }\n        if (force === true) {\n            this.resetMessageDB();\n        }\n        this.messageDb.push({ payload: payload, opt: opt, ackForType: ackForType });\n        if (this.messageTimeout === undefined) {\n            void this.sendMessageLoop();\n        }\n    };\n\n    private readonly sendMessageLoop = async (): Promise<void> => {\n        const msg = this.messageDb[0];\n        if (this.adapter.config.debugLogMqtt) {\n            this.log.debug(\n                `sendMessageLoop - messages in queue: ${this.messageDb.length} handling message: ${JSON.stringify(msg)}`,\n            );\n        }\n        if (msg === undefined || this.unload) {\n            if (this.adapter.config.debugLogMqtt) {\n                this.log.debug(`No message to send or unload - stop send loop`);\n            }\n            if (this.messageTimeout) {\n                this.adapter.clearTimeout(this.messageTimeout);\n            }\n            this.messageTimeout = undefined;\n            return;\n        }\n\n        if (this.losingMessageCount > 0 && this.adapter.config.additionalLog) {\n            this.log.warn(`send payload: ${JSON.stringify(msg)} to panel. Losing count: ${this.losingMessageCount}`);\n        }\n        if (this.losingMessageCount++ > 5) {\n            if (this.panel) {\n                if (this.adapter.config.additionalLog) {\n                    this.log.error(`Losing ${this.losingMessageCount} messages - set panel offline!`);\n                }\n                this.panel.isOnline = false;\n            }\n        }\n        this.losingDelay = this.losingDelay + 2000;\n\n        if (this.unload) {\n            return;\n        }\n        if (!this.adapter.unload) {\n            this.messageTimeout = this.adapter.setTimeout(this.sendMessageLoop, this.losingDelay);\n        }\n        this.addMessageTasmota(this.topic, msg.payload, msg.opt);\n    };\n\n    readonly addMessageTasmota = (topic: string, payload: string, opt?: IClientPublishOptions): void => {\n        if (\n            this.messageDbTasmota.length > 0 &&\n            this.messageDbTasmota.some(a => a.topic === topic && a.payload === payload && a.opt === opt)\n        ) {\n            if (this.adapter.config.debugLogMqtt) {\n                this.log.debug(`Tasmota Message ${payload} is already in queue - skip adding`);\n            }\n            return;\n        }\n        if (this.unload || this.adapter.unload) {\n            this.messageDbTasmota = [];\n        }\n\n        if (this.adapter.config.debugLogMqtt) {\n            this.log.debug(`add Tasmota message ${payload} to queue`);\n        }\n        this.messageDbTasmota.push({ topic: topic, payload: payload, opt: opt });\n\n        if (this.messageTimeoutTasmota === undefined) {\n            void this.sendMessageLoopTasmota();\n        }\n    };\n    private readonly sendMessageLoopTasmota = async (): Promise<void> => {\n        const msg = this.messageDbTasmota.shift();\n        if (msg === undefined) {\n            if (this.messageTimeoutTasmota && this.messageTimeoutTasmota !== true) {\n                this.adapter.clearTimeout(this.messageTimeoutTasmota);\n            }\n            this.messageTimeoutTasmota = undefined;\n            return;\n        }\n        //if (this.adapter.config.debugLogMqtt) {\n        this.log.debug(`send payload: ${JSON.stringify(msg)} to panel.`);\n        //}\n        this.messageTimeoutTasmota = true;\n        try {\n            await this.mqttClient.publish(msg.topic, msg.payload, { ...(msg.opt ?? {}), qos: 1 });\n        } catch (e) {\n            this.log.warn(`MQTT publish failed: ${(e as Error).message}`);\n            // optional: Requeue\n            this.messageDbTasmota.unshift(msg);\n            this.losingDelay = this.losingDelay + 1000; // sanfter Backoff\n        }\n        if (this.unload || this.adapter.unload) {\n            return;\n        }\n        this.messageTimeoutTasmota = this.adapter.setTimeout(this.sendMessageLoopTasmota, 10);\n    };\n\n    async delete(): Promise<void> {\n        await super.delete();\n        this.mqttClient.unsubscribe(`${this.configTopic}/stat/RESULT`);\n        if (this.messageTimeout) {\n            this.adapter.clearTimeout(this.messageTimeout);\n        }\n        if (this.messageTimeoutTasmota && this.messageTimeoutTasmota !== true) {\n            this.adapter.clearTimeout(this.messageTimeoutTasmota);\n        }\n        (this as any).onMessage = async () => {};\n        this.panel = undefined;\n        this.messageDb = [];\n        this.messageDbTasmota = [];\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
