import{A as D,b as A,c as M,S as X,C as Y,I as se,w as z,d as ae,a as re,W as le}from"./NavigationView-cLhTZAwI.js";import{j as e}from"./createSvgIcon-CqxGZo2P.js";import{A as t}from"./AdminComponentEasyAccessSet__loadShare___mf_0_mui_mf_1_material__loadShare__-EKOPJIKX.js";import{R as B}from"./AdminComponentEasyAccessSet__loadShare__react__loadShare__-CJmceRyn.js";import{N as de,S as he,E as ce,D as ie,V as pe,a as me,C as xe,b as ge,c as ue}from"./VisibilityOff-DBb3x0Df.js";import{g as ve}from"./_commonjsHelpers-CE1G-McA.js";import{_ as fe,A as $}from"./_baseIsEqual-BiOdebYq.js";import{A as y}from"./AdminComponentEasyAccessSet__loadShare___mf_0_iobroker_mf_1_adapter_mf_2_react_mf_2_v5__loadShare__-BJiKjF1c.js";import{T as ee,y as U}from"./Tooltip-CfJTkqcA.js";import{g as O,r as G,b as R,o as J,a as H}from"./defaultTheme-BaXk_AWg.js";import"./index-D7flN5de.js";import"./AdminComponentEasyAccessSet__mf_v__runtimeInit__mf_v__-9o5tLcPN.js";import"./Clear-XNmT7EC0.js";import"./useTheme-DpgbzTgk.js";import"./Grow-DNaTkyCv.js";var Ce=fe;function ye(k,s){return Ce(k,s)}var Te=ye;const be=ve(Te);class ne extends D.ConfigGeneric{static defaultProps={widthPercent:30};constructor(s){super(s),this.state={...this.state,available:[],selectedTopic:"",added:[],assignments:s.currentAssignments||[],pagesMap:{},alive:!1,isCollapsed:!s.uniqueName,isLoading:{},lastLoadTime:{},focusReceived:{},retryCount:{},activeTab:0}}componentWillUnmount(){if(this.props.oContext&&this.props.oContext.socket){const s=this.props.oContext.instance??"0";this.props.oContext.socket.unsubscribeState(`system.adapter.${A}.${s}.alive`,this.onAliveChanged)}}async componentDidMount(){if(super.componentDidMount(),this.props.oContext&&this.props.oContext.socket){const s=this.props.oContext.instance??"0",a=`system.adapter.${A}.${s}.alive`;try{const n=await this.props.oContext.socket.getState(a),i=!!(n!=null&&n.val);this.setState({alive:i}),await this.props.oContext.socket.subscribeState(a,this.onAliveChanged)}catch(n){console.error("[NavigationAssignmentPanel] Failed to get alive state or subscribe:",n),this.setState({alive:!1})}}await this.loadPanels(!1),await this.applyAssignmentsFromProps(this.props.currentAssignments||[])}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&(this.setState({alive:i}),!n&&i&&this.state.assignments.length>0&&this.retryLoadingPagesForAssignments())};async applyAssignmentsFromProps(s){var d;const a=(s||[]).map(h=>this.state.available.find(c=>c.panelTopic===h.topic)||{panelTopic:h.topic,friendlyName:h.topic}).sort((h,l)=>h.friendlyName.localeCompare(l.friendlyName));console.log(`[NavigationAssignmentPanel] applyAssignmentsFromProps: available=${JSON.stringify(this.state.available)}, added=${JSON.stringify(a)}`);const n=this.state.selectedAddedTopic,r=a.find(h=>h.panelTopic===n)?n:(d=a[0])==null?void 0:d.panelTopic;this.setState({assignments:s,added:a,selectedAddedTopic:r,selectedTopic:""});const o=a.map(h=>this.loadPagesForPanel(h.panelTopic,!0));await Promise.all(o)}componentDidUpdate(s){if(s.uniqueName!==this.props.uniqueName){const a=this.props.currentAssignments||[];this.props.uniqueName?this.setState(n=>({focusReceived:{...n.focusReceived,[this.props.uniqueName]:!0},isCollapsed:!1})):this.setState({isCollapsed:!0}),this.loadPanels(!1).then(()=>{this.applyAssignmentsFromProps(a)})}else if(this.props.currentAssignments&&!be(s.currentAssignments||{},this.props.currentAssignments||{})){const a=this.props.currentAssignments||[];this.applyAssignmentsFromProps(a)}}async loadPanels(s=!0){var a;try{let n=[];this.props.fetchPanels?n=await this.props.fetchPanels():(a=this.props.data)!=null&&a.panels&&(n=(this.props.data.panels||[]).map(i=>({panelTopic:i.topic,friendlyName:i.name||i.topic}))),await new Promise(i=>this.setState({available:n,selectedTopic:""},()=>i()))}catch{this.setState({available:[],selectedTopic:""})}}doAddSelected=()=>{const{selectedTopic:s,available:a,added:n}=this.state;if(!s)return;let i=a.find(d=>d.panelTopic===s);if(!i&&s===M&&(i={panelTopic:M,friendlyName:`(${y.I18n.t("all")||"All"})`}),!i||n.find(d=>d.panelTopic===i.panelTopic))return;const r=[...n,i],o=[...this.state.assignments,{topic:i.panelTopic}];this.setState({added:r,assignments:o,selectedTopic:""}),this.loadPagesForPanel(i.panelTopic),this.props.onAssign&&this.props.uniqueName&&this.props.onAssign(this.props.uniqueName,o)};doRemoveSelected=()=>{const{added:s,selectedAddedTopic:a}=this.state;if(s.length)if(a){const n=s.filter(d=>d.panelTopic!==a),i=this.state.assignments.filter(d=>d.topic!==a),r=s.findIndex(d=>d.panelTopic===a);let o;if(n.length>0){const d=n[r]??n[r-1]??n[0];o=d==null?void 0:d.panelTopic}else o=void 0;this.setState({added:n,assignments:i,selectedAddedTopic:o}),this.props.onAssign&&this.props.uniqueName&&this.props.onAssign(this.props.uniqueName,i)}else{const n=s.slice(0,-1),i=this.state.assignments.slice(0,-1),r=n.length?n[n.length-1].panelTopic:void 0;this.setState({added:n,assignments:i,selectedAddedTopic:r}),this.props.onAssign&&this.props.uniqueName&&this.props.onAssign(this.props.uniqueName,i)}};selectAdded=s=>{this.setState({selectedAddedTopic:s}),this.loadPagesForPanel(s,!0)};retryLoadingPagesForAssignments(){const s=this.state.assignments.map(a=>a.topic);for(const a of s)this.loadPagesForPanel(a,!0)}async loadPagesForPanel(s,a=!1){var h,l;if(!s)return;if(!this.state.alive){console.log(`[NavigationAssignmentPanel] Adapter not alive, skipping pages load for ${s}`);return}const n=Date.now(),i=this.state.lastLoadTime[s]||0,r=this.state.isLoading[s],o=!!this.state.pagesMap[s],d=a||!o||n-i>6e4;if(!(r||!d&&o)){this.setState(c=>({isLoading:{...c.isLoading,[s]:!0},lastLoadTime:{...c.lastLoadTime,[s]:n}}));try{let c=[],p=!1;if((h=this.props.oContext)!=null&&h.socket){const v=this.props.oContext.instance??"0",g=`${A}.${v}`,j={panelTopic:s};try{const b=new Promise((q,E)=>{setTimeout(()=>E(new Error("sendTo timeout after 2 seconds")),2e3)}),N=this.props.oContext.socket.sendTo(g,X,j),x=await Promise.race([N,b]);Array.isArray(x)?(c=x,p=!0):x&&Array.isArray(x.result)&&(c=x.result,p=!0),console.log("[NavigationAssignmentPanel] sendTo successful",{topic:s,pages:c})}catch(b){console.warn("[NavigationAssignmentPanel] sendTo failed or timed out",{target:g,cmd:X,payload:j,error:b})}}if(p&&c.length===0){const v=this.state.retryCount[s]||0,g=3,j=2e3;if(v<g){console.log(`[NavigationAssignmentPanel] Got empty array for ${s}, retrying in ${j}ms (attempt ${v+1}/${g})`),this.setState(b=>({retryCount:{...b.retryCount,[s]:v+1}})),setTimeout(()=>{this.setState(b=>({isLoading:{...b.isLoading,[s]:!1}})),this.loadPagesForPanel(s,!0)},j);return}console.log(`[NavigationAssignmentPanel] Max retries reached for ${s}, accepting empty result`),this.setState(b=>({retryCount:{...b.retryCount,[s]:0}}))}else p&&c.length>0&&this.setState(v=>({retryCount:{...v.retryCount,[s]:0}}));if(!p&&!((l=this.props.oContext)!=null&&l.socket)&&(await new Promise(v=>setTimeout(v,1e3)),this.setState(v=>({isLoading:{...v.isLoading,[s]:!1}})),!this.state.focusReceived[s]))return this.setState(v=>({focusReceived:{...v.focusReceived,[s]:!0}})),this.loadPagesForPanel(s,!0);const T=this.state.pagesMap?this.state.pagesMap[s]:void 0,C=!!(this.state.isLoading&&this.state.isLoading[s]);(!(Array.isArray(T)&&T.length===c.length&&T.every((v,g)=>v===c[g]))||C!==!1)&&this.setState(v=>({pagesMap:{...v.pagesMap,[s]:c},isLoading:{...v.isLoading,[s]:!1}}))}catch(c){console.error("[NavigationAssignmentPanel] loadPagesForPanel error",{topic:s,error:c}),this.setState(p=>({isLoading:{...p.isLoading,[s]:!1}}))}}}setNavigationForSelected=s=>{const{selectedAddedTopic:a,assignments:n}=this.state;if(!a)return;const i=n.findIndex(h=>h.topic===a),r=[...n],o=n[i],d={topic:a,navigation:{...o==null?void 0:o.navigation,...s}};i>=0?r[i]=d:r.push(d),this.setState({assignments:r}),this.props.onAssign&&this.props.uniqueName&&this.props.onAssign(this.props.uniqueName,r)};getNavValue=(s,a)=>{var r;if(!s)return"";const n=this.state.assignments.find(o=>o.topic===s);return((r=n==null?void 0:n.navigation)==null?void 0:r[a])||""};togglePanel=()=>{const s=this.state.isCollapsed;this.setState(a=>({isCollapsed:!a.isCollapsed})),s&&this.applyAssignmentsFromProps(this.props.currentAssignments||[])};handleTabChange=(s,a)=>{this.setState({activeTab:a})};handleCommonFieldChange(s,a){this.props.onCommonFieldsChange&&this.props.onCommonFieldsChange({[s]:a})}renderCommonFields(){const{commonFields:s}=this.props;return s?e.jsxs(t.Box,{sx:{mt:2,pt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsx(t.Box,{sx:{mb:2},children:e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:!!s.hidden,onChange:(a,n)=>{this.handleCommonFieldChange("hidden",n)},disabled:!this.state.alive}),label:y.I18n.t("hidden")})}),e.jsx(t.Box,{sx:{mt:2},children:e.jsxs(t.FormControl,{component:"fieldset",disabled:!this.state.alive,children:[e.jsx(t.Typography,{variant:"subtitle2",sx:{mb:1},children:y.I18n.t("alwaysOn")}),e.jsxs(t.RadioGroup,{row:!0,value:s.alwaysOn||"none",onChange:(a,n)=>{this.handleCommonFieldChange("alwaysOn",n)},children:[e.jsx(t.FormControlLabel,{value:"none",control:e.jsx(t.Radio,{}),label:y.I18n.t("alwaysOn_none")}),e.jsx(t.FormControlLabel,{value:"always",control:e.jsx(t.Radio,{}),label:y.I18n.t("alwaysOn_always")}),e.jsx(t.FormControlLabel,{value:"ignore",control:e.jsx(t.Radio,{}),label:y.I18n.t("alwaysOn_ignore")})]})]})})]}):e.jsx(t.Box,{sx:{mt:2},children:e.jsx(t.Typography,{variant:"body2",color:"text.secondary",children:this.getText("select_description")})})}renderItem(s,a,n){const{widthPercent:i}=this.props,{isCollapsed:r,activeTab:o}=this.state,d=this.state.selectedAddedTopic?this.state.pagesMap[this.state.selectedAddedTopic]??[]:[],h=r||!this.props.uniqueName;return e.jsxs(t.Box,{sx:{position:{xs:"static",md:"absolute"},right:{xs:"auto",md:0},top:{xs:"auto",md:0},height:{xs:"auto",md:"100%"},width:{xs:"100%",md:h?"10px":`${i}%`},minHeight:{xs:h?"50px":"auto",md:"auto"},transition:"width 240ms ease, min-height 240ms ease",backgroundColor:"background.default",border:{xs:"2px solid",md:"none"},borderLeft:{xs:"none",md:"2px solid"},borderTop:{xs:"none",md:"2px solid"},borderColor:"secondary.main",borderRadius:{xs:1,md:0},overflow:{xs:"hidden",md:"visible"},display:"flex",flexDirection:"column",zIndex:20,mt:{xs:2,md:0}},children:[e.jsx(t.Box,{sx:{display:{xs:"none",md:"flex"},position:"absolute",left:"-20px",top:"50%",transform:"translateY(-50%)",width:"20px",height:"60px",backgroundColor:"secondary.main",borderRadius:"4px 0 0 4px",alignItems:"center",justifyContent:"center",cursor:this.props.uniqueName?"pointer":"not-allowed",opacity:this.props.uniqueName?1:.5,zIndex:21,"&:hover":{backgroundColor:"secondary.dark"}},onClick:()=>{this.props.uniqueName&&this.togglePanel()},children:e.jsx(t.Typography,{sx:{color:"secondary.contrastText",fontSize:"14px",fontWeight:"bold",transform:"rotate(-90deg)",whiteSpace:"nowrap"},children:h?"⏶":"⏷"})}),e.jsx(t.Box,{sx:{display:{xs:"flex",md:"none"},alignItems:"center",justifyContent:"center",p:1,backgroundColor:"secondary.main",color:"secondary.contrastText",borderRadius:"4px 4px 0 0"},children:e.jsx(t.Typography,{variant:"subtitle2",sx:{fontWeight:600},children:y.I18n.t("navigation_panel")})}),e.jsxs(t.Box,{sx:{p:1,height:"100%",display:{xs:"flex",md:h?"none":"flex"},flexDirection:"column",width:{xs:"100%",md:h?"0%":"100%"},overflow:"hidden",transition:{xs:"none",md:"width 240ms ease"}},children:[e.jsx(t.Typography,{variant:"h6",sx:{mb:1,fontWeight:600,color:"primary.main",fontSize:"1rem",display:{xs:"none",md:"block"}},children:y.I18n.t("navigation_panel")}),e.jsxs(t.Tabs,{value:o??0,onChange:this.handleTabChange,variant:"scrollable",scrollButtons:!1,sx:{mb:1,minHeight:{xs:36,md:48},"& .MuiTab-root":{minHeight:{xs:36,md:48},py:{xs:.5,md:1.5},fontSize:{xs:"0.75rem",md:"0.875rem"}}},"aria-label":"Navigation assignment tabs",children:[e.jsx(t.Tab,{icon:e.jsx(de,{sx:{fontSize:{xs:18,md:20}}}),iconPosition:"start",label:e.jsxs(e.Fragment,{children:[e.jsx(t.Box,{component:"span",sx:{display:{xs:"inline",md:"none"}},children:y.I18n.t("nav")||"Nav"}),e.jsx(t.Box,{component:"span",sx:{display:{xs:"none",md:"inline"}},children:y.I18n.t("navigation")||"Navigation"})]}),sx:{minWidth:{xs:"auto",md:90},px:{xs:1,md:2}},disabled:!this.state.alive}),e.jsx(t.Tab,{icon:e.jsx(he,{sx:{fontSize:{xs:18,md:20}}}),iconPosition:"start",label:e.jsxs(e.Fragment,{children:[e.jsx(t.Box,{component:"span",sx:{display:{xs:"inline",md:"none"}},children:y.I18n.t("details")||"Details"}),e.jsx(t.Box,{component:"span",sx:{display:{xs:"none",md:"inline"}},children:y.I18n.t("pagedetails")||"Page Details"})]}),sx:{minWidth:{xs:"auto",md:90},px:{xs:1,md:2}},disabled:!this.state.alive}),e.jsx(t.Tab,{icon:e.jsx(ce,{sx:{fontSize:{xs:18,md:20}}}),iconPosition:"start",label:e.jsxs(e.Fragment,{children:[e.jsx(t.Box,{component:"span",sx:{display:{xs:"inline",md:"none"}},children:y.I18n.t("free")||"Free"}),e.jsx(t.Box,{component:"span",sx:{display:{xs:"none",md:"inline"}},children:y.I18n.t("placeholder")||"Placeholder"})]}),sx:{minWidth:{xs:"auto",md:90},px:{xs:1,md:2}},disabled:!this.state.alive})]}),o===0&&e.jsxs(e.Fragment,{children:[e.jsxs(t.Box,{sx:{display:"flex",gap:1,alignItems:"center",mb:1},children:[e.jsxs(t.Select,{size:"small",variant:"standard",value:this.state.selectedTopic,onOpen:()=>{this.loadPanels()},onChange:l=>this.setState({selectedTopic:String(l.target.value)}),disabled:!this.state.alive,sx:{flex:1,backgroundColor:"transparent",minHeight:40,"& .MuiSelect-select":{backgroundColor:"transparent",display:"flex",alignItems:"center",height:40}},displayEmpty:!0,children:[e.jsx(t.MenuItem,{value:"",children:e.jsx("em",{children:"—"})}),!this.state.added.some(l=>l.panelTopic===M)&&e.jsx(t.MenuItem,{value:M,children:`(${y.I18n.t("all")||"All"})`}),this.state.available.filter(l=>!this.state.added.some(c=>c.panelTopic===l.panelTopic)).map(l=>e.jsx(t.MenuItem,{value:l.panelTopic,children:l.friendlyName},l.panelTopic))]}),e.jsx(t.Button,{size:"small",variant:"contained",sx:{minWidth:32,padding:"4px 8px"},onClick:this.doAddSelected,disabled:!this.state.selectedTopic||!this.state.alive,children:"+"})]}),e.jsx(t.Box,{children:this.state.added.length===0?e.jsx(t.Typography,{variant:"body1",color:"text.secondary",children:y.I18n.t("No panels added")}):e.jsx("div",{style:{overflow:"auto"},children:e.jsx(t.List,{dense:!0,children:this.state.added.map(l=>{const c=l.panelTopic,p=this.state.pendingDelete===c;return e.jsx(B.Fragment,{children:e.jsx(t.ListItem,{component:"div",disablePadding:!0,sx:{"&:hover .delete-icon":{opacity:1}},secondaryAction:e.jsx(t.IconButton,{disabled:!this.state.alive,className:"delete-icon",edge:"end","aria-label":"delete",size:"small",onClick:T=>{var C;if(this.state.alive)if(T.stopPropagation(),!p)this.setState({pendingDelete:c}),setTimeout(()=>{this.state.pendingDelete===c&&this.setState({pendingDelete:void 0})},3e3);else{const w=this.state.added.filter(j=>j.panelTopic!==c),v=this.state.assignments.filter(j=>j.topic!==c),g=w.length>0?(C=w[0])==null?void 0:C.panelTopic:void 0;this.setState({added:w,assignments:v,selectedAddedTopic:g,pendingDelete:void 0}),this.props.onAssign&&this.props.uniqueName&&this.props.onAssign(this.props.uniqueName,v)}},sx:{color:p?"error.dark":"error.main",opacity:{xs:1,md:0},transition:"opacity 0.2s",backgroundColor:p?"error.main":"transparent","&:hover":{backgroundColor:p?"error.dark":"action.hover"},pointerEvents:this.state.alive?"auto":"none"},children:e.jsx(ie,{fontSize:"small"})}),children:e.jsx(t.ListItemButton,{selected:this.state.selectedAddedTopic===c,onClick:()=>{this.selectAdded(c),this.setState({pendingDelete:void 0})},sx:{pr:6},disabled:!this.state.alive,children:e.jsx(t.ListItemText,{primary:c===M?`(${y.I18n.t("all")||"All"})`:l.friendlyName,slotProps:{primary:{sx:{fontSize:"1.05rem",lineHeight:1.2}}},sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis"}})})})},c)})})})}),e.jsx(t.Divider,{sx:{my:1}}),!this.props.hideNavigationFields&&e.jsxs(t.Box,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1,mt:1},children:[e.jsxs(t.Box,{children:[e.jsx(t.Box,{sx:{display:"flex",alignItems:"center",mb:.5},children:e.jsx(ee,{title:y.I18n.t("nav_prev_tooltip"),children:e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{mr:.5},children:"prev"})})}),e.jsxs(t.Select,{size:"small",displayEmpty:!0,"aria-label":"prev",value:this.getNavValue(this.state.selectedAddedTopic,"prev")||"",onOpen:()=>{this.state.selectedAddedTopic&&this.loadPagesForPanel(this.state.selectedAddedTopic,!0)},onChange:l=>this.setNavigationForSelected({prev:String(l.target.value)||void 0}),sx:{width:"100%"},disabled:!this.state.alive||this.state.selectedAddedTopic&&this.state.isLoading[this.state.selectedAddedTopic]||!1,endAdornment:this.state.selectedAddedTopic&&this.state.isLoading[this.state.selectedAddedTopic]?e.jsx(t.Box,{sx:{display:"flex",alignItems:"center",pr:1},children:e.jsx(t.CircularProgress,{size:16})}):null,children:[e.jsx(t.MenuItem,{value:"",children:this.state.selectedAddedTopic?e.jsx("em",{children:"—"}):e.jsx("em",{children:y.I18n.t("select_panel_first")})}),d.filter(l=>l!==this.props.uniqueName).map(l=>e.jsx(t.MenuItem,{value:l,children:l},`prev-${l}`))]})]}),e.jsxs(t.Box,{children:[e.jsx(t.Box,{sx:{display:"flex",alignItems:"center",mb:.5},children:e.jsx(ee,{title:y.I18n.t("nav_next_tooltip"),children:e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{mr:.5},children:"next"})})}),e.jsxs(t.Select,{size:"small",displayEmpty:!0,"aria-label":"next",value:this.getNavValue(this.state.selectedAddedTopic,"next")||"",onOpen:()=>{this.state.selectedAddedTopic&&this.loadPagesForPanel(this.state.selectedAddedTopic,!0)},onChange:l=>this.setNavigationForSelected({next:String(l.target.value)||void 0}),sx:{width:"100%"},disabled:!this.state.alive||this.state.selectedAddedTopic&&this.state.isLoading[this.state.selectedAddedTopic]||!1,endAdornment:this.state.selectedAddedTopic&&this.state.isLoading[this.state.selectedAddedTopic]?e.jsx(t.Box,{sx:{display:"flex",alignItems:"center",pr:1},children:e.jsx(t.CircularProgress,{size:16})}):null,children:[e.jsx(t.MenuItem,{value:"",children:this.state.selectedAddedTopic?e.jsx("em",{children:"—"}):e.jsx("em",{children:y.I18n.t("select_panel_first")})}),d.filter(l=>l!==this.props.uniqueName&&!l.startsWith("///")).map(l=>e.jsx(t.MenuItem,{value:l,children:l},`next-${l}`))]})]}),e.jsxs(t.Box,{children:[e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{mb:.5,display:"block"},children:"home"}),e.jsxs(t.Select,{size:"small",displayEmpty:!0,"aria-label":"home",value:this.getNavValue(this.state.selectedAddedTopic,"home")||"",onOpen:()=>{this.state.selectedAddedTopic&&this.loadPagesForPanel(this.state.selectedAddedTopic,!0)},onChange:l=>this.setNavigationForSelected({home:String(l.target.value)||void 0}),sx:{width:"100%"},disabled:!this.state.alive||this.state.selectedAddedTopic&&this.state.isLoading[this.state.selectedAddedTopic]||!1,endAdornment:this.state.selectedAddedTopic&&this.state.isLoading[this.state.selectedAddedTopic]?e.jsx(t.Box,{sx:{display:"flex",alignItems:"center",pr:1},children:e.jsx(t.CircularProgress,{size:16})}):null,children:[e.jsx(t.MenuItem,{value:"",children:e.jsx("em",{children:"—"})}),d.filter(l=>l!==this.props.uniqueName).map(l=>e.jsx(t.MenuItem,{value:l,children:l},`home-${l}`))]})]}),e.jsxs(t.Box,{children:[e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{mb:.5,display:"block"},children:"parent"}),e.jsxs(t.Select,{size:"small",displayEmpty:!0,"aria-label":"parent",value:this.getNavValue(this.state.selectedAddedTopic,"parent")||"",onOpen:()=>{this.state.selectedAddedTopic&&this.loadPagesForPanel(this.state.selectedAddedTopic,!0)},onChange:l=>this.setNavigationForSelected({parent:String(l.target.value)||void 0}),sx:{width:"100%"},disabled:!this.state.alive||this.state.selectedAddedTopic&&this.state.isLoading[this.state.selectedAddedTopic]||!1,endAdornment:this.state.selectedAddedTopic&&this.state.isLoading[this.state.selectedAddedTopic]?e.jsx(t.Box,{sx:{display:"flex",alignItems:"center",pr:1},children:e.jsx(t.CircularProgress,{size:16})}):null,children:[e.jsx(t.MenuItem,{value:"",children:e.jsx("em",{children:"—"})}),d.filter(l=>l!==this.props.uniqueName).map(l=>e.jsx(t.MenuItem,{value:l,children:l},`parent-${l}`))]})]}),e.jsx(t.Divider,{sx:{my:1}})]}),this.state.added.length>0?this.state.added.map(l=>{const c=l.panelTopic,p=this.state.added.some(x=>x.panelTopic===M),T=this.getNavValue(c,"next"),C=this.getNavValue(c,"prev"),w=this.getNavValue(c,"home"),v=this.getNavValue(c,"parent"),g=!!(T||C||w||v),j=c===M,b=!T&&!C,N=j?"nav_all_requires_prev_next":p?"nav_remove_from_all_notice":"nav_target_only_notice";return e.jsxs(t.Box,{"data-has-all":p,sx:{mt:2,mb:1},children:[e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(t.Box,{sx:{width:10,height:10,borderRadius:"50%",bgcolor:g?"success.main":"error.main"}}),e.jsx(t.Typography,{variant:"subtitle2",sx:{fontWeight:600},children:c===M?`(${y.I18n.t("all")||"All"})`:l.friendlyName||c})]}),e.jsx(t.Box,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:["next","prev","parent","home"].map((x,q)=>{const E=this.getNavValue(c,x);return e.jsxs(B.Fragment,{children:[e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(t.Typography,{variant:"caption",color:"text.secondary",children:y.I18n.t(x)||x}),e.jsx(t.Typography,{variant:"body2",children:E||e.jsx("em",{children:"—"})})]}),q<3&&e.jsx(t.Divider,{orientation:"vertical",flexItem:!0,sx:{height:18,mx:1}})]},`${c}-${x}`)})}),b?e.jsx(t.Box,{sx:{mt:1},children:e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{fontStyle:"italic"},children:y.I18n.t(N)})}):null]},`panel-summary-${c}`)}):null]}),o===1&&e.jsx(e.Fragment,{children:this.renderCommonFields()}),o===2&&e.jsx(e.Fragment,{children:e.jsx(t.Typography,{variant:"body1",color:"text.secondary",children:y.I18n.t("Placeholder content for this tab.")})})]})]})}}class je extends B.Component{constructor(s){super(s),this.state={newName:"",confirmDeleteOpen:!1,confirmDeleteName:null,alive:!1}}componentWillUnmount(){const s=this.props.oContext.instance??"0";this.props.oContext.socket.unsubscribeState(`system.adapter.${A}.${s}.alive`,this.onAliveChanged)}async componentDidMount(){const s=this.props.oContext.instance??"0",a=`system.adapter.${A}.${s}.alive`;try{const n=await this.props.oContext.socket.getState(a),i=!!(n!=null&&n.val);this.setState({alive:i}),await this.props.oContext.socket.subscribeState(a,this.onAliveChanged)}catch(n){console.error("[PageConfigLayout] Failed to get alive state or subscribe:",n),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&(console.log("[PageConfigLayout] Alive state changed:",{wasAlive:n,isAlive:i}),this.setState({alive:i}))};getText(s){return this.props.getText(s)}handleAdd=()=>{const s=this.state.newName.trim();!s||this.props.selectedCardType==="all"||(this.props.onAdd(s,this.props.selectedCardType),this.setState({newName:""}),this.props.onSelectedChange(s))};handleDeleteClick=s=>{this.setState({confirmDeleteOpen:!0,confirmDeleteName:s})};handleDeleteConfirm=()=>{const s=this.state.confirmDeleteName;if(!s){this.setState({confirmDeleteOpen:!1,confirmDeleteName:null});return}this.props.onDelete(s),this.setState({confirmDeleteOpen:!1,confirmDeleteName:null})};handleDeleteCancel=()=>{this.setState({confirmDeleteOpen:!1,confirmDeleteName:null})};render(){const{entries:s,selected:a,selectedCardType:n,onSelectedChange:i,onCardTypeChange:r,onAssign:o,children:d,oContext:h,navigationPanelProps:l}=this.props,c=Array.from(new Set(s.map(g=>g.uniqueName))).filter(Boolean),p=n==="all"?s:s.filter(g=>g.card===n),T=Array.from(new Set(p.map(g=>g.uniqueName))).filter(Boolean),C=s.find(g=>g.uniqueName===a),w=(C==null?void 0:C.navigationAssignment)||[],v=`https://github.com/ticaki/ioBroker.nspanel-lovelace-ui/wiki/${encodeURIComponent(n==="all"?C!=null&&C.card?C.card:"PageConfig":n)}`;return e.jsxs(t.Box,{sx:{height:"calc(100vh - 64px)",display:"flex",flexDirection:{xs:"column",md:"row"},p:1},children:[e.jsxs(t.Box,{sx:{width:{xs:"100%",md:"20%"},pr:{xs:0,md:1},display:"flex",flexDirection:"column",gap:1},children:[e.jsx(t.Paper,{sx:{p:0,mb:1,backgroundColor:"transparent"},elevation:0,children:e.jsxs(t.FormControl,{fullWidth:!0,variant:"standard",children:[e.jsx(t.Typography,{variant:"h6",sx:{mb:1,fontWeight:600,color:"primary.main",fontSize:"1rem"},children:this.getText("page_type")}),e.jsxs(t.Select,{disabled:!this.state.alive,value:n,onChange:g=>{r(g.target.value)},sx:{backgroundColor:"transparent",px:1},children:[e.jsx(t.MenuItem,{value:"all",children:this.getText("page_type_all")}),e.jsx(t.MenuItem,{value:"cardAlarm",children:this.getText("page_type_alarm")}),e.jsx(t.MenuItem,{value:"cardQR",children:this.getText("page_type_qr")}),e.jsx(t.MenuItem,{value:"cardTrash",children:this.getText("page_type_trash")})]})]})}),e.jsx(t.Typography,{variant:"h6",sx:{mt:1,fontWeight:600,color:"primary.main",fontSize:"1rem"},children:this.getText("pages")}),n!=="all"&&e.jsx(t.Paper,{sx:{p:0,backgroundColor:"transparent"},elevation:0,children:e.jsxs(t.Box,{sx:{display:"flex",gap:1},children:[e.jsx(t.TextField,{disabled:!this.state.alive,"aria-label":"new-name",label:this.getText("new_page"),value:this.state.newName,onChange:g=>{this.setState({newName:g.target.value})},variant:"standard",placeholder:this.getText("New item"),InputProps:{sx:{backgroundColor:"transparent",px:1}},sx:{flex:1,"& .MuiInput-underline:before":{borderBottomColor:"primary.main"},"& .MuiInput-underline:hover:before":{borderBottomColor:"primary.main"},"& .MuiInput-underline:after":{borderBottomColor:"primary.main"},"& .MuiInputLabel-root":{color:"primary.main"},"& .MuiInputLabel-root.Mui-focused":{color:"primary.main"}}}),e.jsx(t.Button,{size:"small",variant:"contained",onClick:this.handleAdd,disabled:!this.state.alive||!this.state.newName.trim()||c.includes(this.state.newName.trim()),children:"+"})]})}),e.jsx(t.Paper,{sx:{overflow:"auto",p:0,backgroundColor:"transparent"},elevation:0,children:T.length===0?e.jsx(t.Typography,{variant:"body2",color:"text.secondary",children:this.getText("No items")}):T.map(g=>e.jsxs(t.Box,{onClick:()=>{i(g)},sx:{p:1,borderRadius:1,cursor:"pointer",backgroundColor:a===g?"action.selected":"transparent",mb:.5,display:"flex",justifyContent:"space-between",alignItems:"center","&:hover .delete-icon":{opacity:1}},children:[e.jsx(t.Typography,{variant:"body2",sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis"},children:g}),e.jsx(t.IconButton,{disabled:!this.state.alive,className:"delete-icon",edge:"end","aria-label":"delete",size:"small",onClick:j=>{this.state.alive&&(j.stopPropagation(),this.handleDeleteClick(g))},sx:{color:"error.main",opacity:{xs:1,md:0},transition:"opacity 0.2s",pointerEvents:this.state.alive?"auto":"none"},children:e.jsx(ie,{fontSize:"small"})})]},g))}),e.jsx(t.Divider,{sx:{my:1}}),v&&e.jsx(t.Box,{sx:{mb:2},children:e.jsx("a",{href:v,target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none",color:"inherit",fontSize:"0.875rem"},children:e.jsx(t.Typography,{variant:"body2",sx:{color:"primary.main",textDecoration:"underline",cursor:"pointer","&:hover":{opacity:.8}},children:this.getText("documentation")})})})]}),e.jsx(Y,{open:this.state.confirmDeleteOpen,onClose:this.handleDeleteCancel,onConfirm:this.handleDeleteConfirm,title:this.getText("delete_confirm_title"),description:this.getText("delete_confirm_text")+(this.state.confirmDeleteName?`: ${this.state.confirmDeleteName}`:""),cancelText:this.getText("Cancel1"),confirmText:this.getText("Delete"),ariaTitleId:"unlock-delete-confirm-title",ariaDescId:"unlock-delete-confirm-description"}),e.jsxs(t.Box,{sx:{width:{xs:"100%",md:"90%"},pl:{xs:0,md:2},mt:{xs:2,md:0},display:"flex",flexDirection:{xs:"column",md:"row"},gap:1,position:"relative"},children:[e.jsx(t.Box,{sx:{width:{xs:"100%",md:"95%"},borderLeft:{xs:"none",md:"1px solid"},borderColor:"divider",overflow:"hidden",display:"flex",flexDirection:"column"},children:e.jsx(t.Paper,{sx:{height:"100%",p:2,overflow:"auto",display:"flex",flexDirection:"column"},elevation:1,children:d})}),e.jsx(ne,{...l,widthPercent:30,uniqueName:a,currentAssignments:w,oContext:h,onAssign:o})]})]})}}class Se extends B.Component{constructor(s){super(s),this.state={showPin:!1,alive:!1}}componentWillUnmount(){const s=this.props.oContext.instance??"0";this.props.oContext.socket.unsubscribeState(`system.adapter.${A}.${s}.alive`,this.onAliveChanged)}async componentDidMount(){const s=this.props.oContext.instance??"0",a=`system.adapter.${A}.${s}.alive`;try{const n=await this.props.oContext.socket.getState(a),i=!!(n!=null&&n.val);this.setState({alive:i}),await this.props.oContext.socket.subscribeState(a,this.onAliveChanged)}catch(n){console.error("[PageAlarmEditor] Failed to get alive state or subscribe:",n),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&(console.log("[PageAlarmEditor] Alive state changed:",{wasAlive:n,isAlive:i}),this.setState({alive:i}))};getText(s){return this.props.getText(s)}handleFieldChange(s,a){const n={...this.props.entry,[s]:a};this.props.onEntryChange(n)}render(){const{entry:s,pagesList:a}=this.props;return e.jsxs(t.Box,{children:[e.jsx(t.Box,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:"action.hover"},children:e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:"text",label:this.getText("unique_label"),value:s.uniqueName,onChange:n=>{const i=n.target.value;i.trim()&&this.props.onUniqueNameChange(s.uniqueName,i)},InputProps:{sx:{backgroundColor:"transparent",px:1,fontWeight:600,width:"50%"}},disabled:!this.state.alive})}),e.jsx(t.Box,{sx:{mb:1},children:e.jsxs(t.FormControl,{component:"fieldset",disabled:!this.state.alive,children:[e.jsx(t.Typography,{variant:"subtitle2",sx:{mb:1},children:this.getText("unlock_type")}),e.jsxs(t.RadioGroup,{row:!0,value:s.alarmType||"",onChange:(n,i)=>{this.handleFieldChange("alarmType",i)},children:[e.jsx(t.FormControlLabel,{value:"alarm",control:e.jsx(t.Radio,{}),label:this.getText("unlock_alarm")}),e.jsx(t.FormControlLabel,{value:"unlock",control:e.jsx(t.Radio,{}),label:this.getText("unlock_unlock")})]})]})}),e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:"text",autoComplete:"off",label:this.getText("headline"),value:s.headline??"",onChange:n=>{this.handleFieldChange("headline",n.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1,width:"50%"}},sx:{mb:2},disabled:!this.state.alive}),e.jsx(t.Box,{sx:{mt:2},children:e.jsx(t.TextField,{variant:"standard",label:this.getText("unlock_pin"),type:this.state.showPin?"text":"password",value:s.pin!==void 0&&s.pin!==null?String(s.pin):"",onChange:n=>{const r=n.target.value.replace(/[^0-9]/g,""),o=r?parseInt(r,10):0;this.handleFieldChange("pin",o)},InputProps:{sx:{backgroundColor:"transparent",px:1},endAdornment:e.jsx(t.InputAdornment,{position:"end",children:e.jsx(t.IconButton,{"aria-label":this.state.showPin?"hide-pin":"show-pin",onClick:()=>{this.setState({showPin:!this.state.showPin})},edge:"end",size:"small",children:this.state.showPin?e.jsx(pe,{fontSize:"small"}):e.jsx(me,{fontSize:"small"})})})},disabled:!this.state.alive})}),s.alarmType==="alarm"&&e.jsxs(t.Box,{sx:{mt:2},children:[e.jsxs(t.Box,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2},children:[e.jsxs(t.Box,{children:[e.jsx(t.Typography,{variant:"subtitle2",sx:{mb:1},children:this.getText("unlock_armed_header")}),e.jsx(t.Box,{sx:{display:"grid",gap:2},children:[1,2,3,4].map(n=>{const i=`button${n}`,r=(n-1)%4+1;return e.jsxs(t.Box,{children:[e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{mb:.5},children:this.getText(`unlock_button${r}_label`)}),e.jsx(t.TextField,{fullWidth:!0,variant:"standard",placeholder:this.getText(`unlock_button${r}_placeholder`),value:s[i]??"",onChange:o=>{this.handleFieldChange(i,o.target.value)},InputProps:{disableUnderline:!0,sx:{backgroundColor:"transparent",px:1,"& input::placeholder":{color:"text.disabled"}}},disabled:!this.state.alive})]},n)})})]}),e.jsxs(t.Box,{children:[e.jsx(t.Typography,{variant:"subtitle2",sx:{mb:1},children:this.getText("unlock_disarmed_header")}),e.jsx(t.Box,{sx:{display:"grid",gap:2},children:[5,6,7,8].map(n=>{const i=`button${n}`,r=(n-1)%4+1;return e.jsxs(t.Box,{children:[e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{mb:.5},children:this.getText(`unlock_button${r}_label`)}),e.jsx(t.TextField,{fullWidth:!0,variant:"standard",placeholder:this.getText(`unlock_button${r}_placeholder`),value:s[i]??"",onChange:o=>{this.handleFieldChange(i,o.target.value)},disabled:!this.state.alive,InputProps:{disableUnderline:!0,sx:{backgroundColor:"transparent",px:1,"& input::placeholder":{color:"text.disabled"}}}})]},n)})})]})]}),e.jsx(t.Box,{sx:{mt:1},children:e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:!!s.approved,onChange:(n,i)=>{this.handleFieldChange("approved",i)},disabled:!this.state.alive}),label:this.getText("unlock_approved")})}),e.jsx(t.Box,{sx:{mt:1},children:e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:!!s.global,onChange:(n,i)=>{this.handleFieldChange("global",i)},disabled:!this.state.alive}),label:this.getText("unlock_global")})})]}),s.alarmType==="unlock"&&e.jsxs(t.Box,{sx:{mt:2},children:[e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{mb:.5},children:this.getText("unlock_setnavi_hint")}),e.jsxs(t.Select,{variant:"standard",displayEmpty:!0,value:s.setNavi??"",onChange:n=>{this.handleFieldChange("setNavi",String(n.target.value))},sx:{backgroundColor:"transparent",px:1,width:"60%"},disabled:!this.state.alive,children:[e.jsx(t.MenuItem,{value:"",children:e.jsx("em",{children:this.getText("unlock_setnavi_placeholder")})}),a.filter(n=>typeof n=="string"&&!n.startsWith("///")&&n!==s.uniqueName).map(n=>e.jsx(t.MenuItem,{value:n,children:n},n)),s.setNavi&&s.setNavi!==s.uniqueName&&!a.includes(s.setNavi)&&e.jsx(t.MenuItem,{value:s.setNavi,children:s.setNavi},`custom-${s.setNavi}`)]})]})]})}}class Q extends B.Component{constructor(s){super(s),this.state={showSelectDialog:!1}}render(){const{label:s,value:a,onChange:n,socket:i,theme:r,themeType:o,dialogName:d,filterFunc:h,disabled:l}=this.props,{showSelectDialog:c}=this.state;return e.jsxs(t.Box,{sx:{mb:1},children:[e.jsx(t.Typography,{variant:"body2",sx:{mb:.5,color:"text.secondary",fontSize:"0.875rem"},children:s}),e.jsxs(t.Box,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(t.TextField,{fullWidth:!0,variant:"standard",value:a||"",onChange:p=>n(p.target.value),disabled:l}),e.jsx(t.Button,{variant:"outlined",onClick:()=>this.setState({showSelectDialog:!0}),sx:{minWidth:48},disabled:l,children:"..."}),c&&e.jsx(y.SelectID,{socket:i,selected:a||"",onOk:p=>{const T=Array.isArray(p)?p[0]:p;n(T||""),this.setState({showSelectDialog:!1})},onClose:()=>this.setState({showSelectDialog:!1}),filterFunc:h||(p=>(p==null?void 0:p.type)==="state"),dialogName:d,theme:r,themeType:o})]})]})}}class Ie extends B.Component{constructor(s){super(s),this.state={showPassword:!1,alive:!1}}componentWillUnmount(){const s=this.props.oContext.instance??"0";this.props.oContext.socket.unsubscribeState(`system.adapter.${A}.${s}.alive`,this.onAliveChanged)}async componentDidMount(){const s=this.props.oContext.instance??"0",a=`system.adapter.${A}.${s}.alive`;try{const n=await this.props.oContext.socket.getState(a),i=!!(n!=null&&n.val);this.setState({alive:i}),await this.props.oContext.socket.subscribeState(a,this.onAliveChanged)}catch(n){console.error("[PageQREditor] Failed to get alive state or subscribe:",n),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&(console.log("[PageQREditor] Alive state changed:",{wasAlive:n,isAlive:i}),this.setState({alive:i}))};getText(s){return this.props.getText(s)}handleFieldChange(s,a){const n={...this.props.entry,[s]:a};this.props.onEntryChange(n)}render(){var i;const{entry:s,oContext:a,theme:n}=this.props;return e.jsxs(t.Box,{children:[e.jsx(t.Box,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:"action.hover"},children:e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:"text",label:this.getText("unique_label"),value:s.uniqueName,onChange:r=>{const o=r.target.value;o.trim()&&this.props.onUniqueNameChange(s.uniqueName,o)},InputProps:{sx:{backgroundColor:"transparent",px:1,fontWeight:600,width:"50%"}},disabled:!this.state.alive})}),e.jsx(t.Box,{sx:{mb:2},children:e.jsxs(t.FormControl,{component:"fieldset",disabled:!this.state.alive,children:[e.jsx(t.FormLabel,{component:"legend",children:this.getText("qr_type")}),e.jsxs(t.RadioGroup,{row:!0,value:s.selType??0,onChange:r=>{const o=parseInt(r.target.value,10);this.handleFieldChange("selType",o)},children:[e.jsx(t.FormControlLabel,{value:0,control:e.jsx(t.Radio,{}),label:this.getText("qr_type_free")}),e.jsx(t.FormControlLabel,{value:1,control:e.jsx(t.Radio,{}),label:this.getText("qr_type_wifi")}),e.jsx(t.FormControlLabel,{value:2,control:e.jsx(t.Radio,{}),label:this.getText("qr_type_url")}),e.jsx(t.FormControlLabel,{value:3,control:e.jsx(t.Radio,{}),label:this.getText("qr_type_tel")})]})]})}),e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:"text",autoComplete:"off",label:this.getText("headline"),value:s.headline??"",onChange:r=>{this.handleFieldChange("headline",r.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1,width:"50%"}},sx:{mb:2},disabled:!this.state.alive}),e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:"text",autoComplete:"off",label:(()=>{switch(s.selType){case 0:return this.getText("qr_content_free");case 1:return this.getText("qr_content_wifi");case 2:return this.getText("qr_content_url");case 3:return this.getText("qr_content_tel");default:return this.getText("qr_content")}})(),value:s.ssidUrlTel??"",onChange:r=>{this.handleFieldChange("ssidUrlTel",r.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1}},sx:{mb:2},disabled:!this.state.alive}),s.selType===1&&e.jsxs(t.Box,{sx:{mb:2},children:[e.jsxs(t.FormControl,{variant:"standard",sx:{mb:2,minWidth:240},disabled:!this.state.alive,children:[e.jsx(t.InputLabel,{children:this.getText("qr_wlan_type")}),e.jsxs(t.Select,{value:s.wlantype??"WPA2",onChange:r=>{const o=r.target.value;this.handleFieldChange("wlantype",o)},children:[e.jsx(t.MenuItem,{value:"nopass",children:"No Password"}),e.jsx(t.MenuItem,{value:"WPA",children:"WPA"}),e.jsx(t.MenuItem,{value:"WPA2",children:"WPA2"}),e.jsx(t.MenuItem,{value:"WPA3",children:"WPA3"}),e.jsx(t.MenuItem,{value:"WEP",children:"WEP"})]})]}),s.wlantype!=="nopass"&&e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:this.state.showPassword?"text":"password",label:this.getText("qr_password"),value:s.qrPass??"",onChange:r=>{this.handleFieldChange("qrPass",r.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1},endAdornment:e.jsx(t.InputAdornment,{position:"end",children:e.jsx(t.IconButton,{"aria-label":"toggle password visibility",onClick:()=>{this.setState({showPassword:!this.state.showPassword})},edge:"end",children:this.state.showPassword?e.jsx($.VisibilityOff,{}):e.jsx($.Visibility,{})})})},sx:{mb:2},disabled:!this.state.alive}),e.jsxs(t.Box,{sx:{display:"flex",gap:2},children:[e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:!!s.wlanhidden,onChange:(r,o)=>{this.handleFieldChange("wlanhidden",o)}}),label:this.getText("qr_wlan_hidden"),disabled:!this.state.alive}),e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:!!s.pwdhidden,onChange:(r,o)=>{this.handleFieldChange("pwdhidden",o)}}),label:this.getText("qr_pwd_hidden"),disabled:!this.state.alive})]}),e.jsx(t.Box,{sx:{mb:2},children:e.jsx(Q,{label:this.getText("qr_set_state"),value:s.setState??void 0,onChange:r=>{this.handleFieldChange("setState",r)},socket:a.socket,theme:n,themeType:((i=n==null?void 0:n.palette)==null?void 0:i.mode)||"light",dialogName:"selectState",filterFunc:r=>!!(r&&r.type==="state"&&r.common&&r.common.type==="boolean"&&r.common.write&&r.common.read),disabled:!this.state.alive})})]})]})}}class _e extends B.Component{fileInputRef=B.createRef();emptyCommon={};constructor(s){super(s),this.state={uploadedEvents:[],selectedEvents:[],alive:!1}}async componentDidMount(){const{oContext:s}=this.props,a=s.instance??"0",n=`system.adapter.${s.adapterName}.${a}.alive`;try{const i=await s.socket.getState(n),r=!!(i!=null&&i.val);this.setState({alive:r}),await s.socket.subscribeState(n,this.onAliveChanged)}catch(i){console.error("[PageTrashEditor] Failed to get alive state:",i),this.setState({alive:!1})}}componentWillUnmount(){const{oContext:s}=this.props,a=s.instance??"0";s.socket.unsubscribeState(`system.adapter.${s.adapterName}.${a}.alive`,this.onAliveChanged)}onAliveChanged=(s,a)=>{const n=a?!!a.val:!1;this.setState({alive:n})};getText(s){return this.props.getText(s)}handleFieldChange(s,a){const n={...this.props.entry,[s]:a};this.props.onEntryChange(n)}handleFileSelect=s=>{var n;const a=(n=s.target.files)==null?void 0:n[0];if(a)try{const{oContext:i}=this.props,r=new FileReader;r.onload=async o=>{var h;const d=(h=o.target)==null?void 0:h.result;if(!d){alert("Upload failed: No content");return}try{const l=await i.socket.sendTo(`${i.adapterName}.${i.instance}`,"uploadIcs",{filename:a.name,content:d});if(l!=null&&l.success)console.log("ICS-Datei erfolgreich hochgeladen:",l.path),this.handleFieldChange("trashFile",l.path),l.events&&Array.isArray(l.events)&&this.setState({uploadedEvents:l.events});else throw new Error(l==null?void 0:l.error);this.fileInputRef.current&&(this.fileInputRef.current.value="")}catch(l){console.error("File upload failed:",l),alert(`Upload failed: ${l.message}`)}},r.onerror=()=>{console.error("File reading failed"),alert("Failed to read file")},r.readAsText(a)}catch(i){console.error("File upload failed:",i),alert(`Upload failed: ${i.message}`)}};handleUploadClick=()=>{var s;(s=this.fileInputRef.current)==null||s.click()};handleToggleEvent=s=>{const{selectedEvents:a}=this.state,n=a.indexOf(s),i=[...a];n===-1?i.length<6&&i.push(s):i.splice(n,1),this.setState({selectedEvents:i})};handleApplySelection=()=>{const{selectedEvents:s}=this.state,{entry:a}=this.props,n={...a};n.items=a.items.map((i,r)=>({...i,textTrash:s[r]||""})),this.props.onEntryChange(n),this.setState({selectedEvents:[],uploadedEvents:[]})};handleItemChange(s,a,n){const i={...this.props.entry};i.items=[...i.items],i.items[s]={...i.items[s],[a]:n},this.props.onEntryChange(i)}getIconValueFromChange(s,a){return typeof s=="string"?typeof a=="string"?a:"":typeof s.icon=="string"?s.icon:""}handleSearchClick=async()=>{const{entry:s,oContext:a}=this.props;if(!s.trashState){alert("Bitte wählen Sie zuerst einen State aus");return}try{const n=await a.socket.getState(s.trashState);if(!n||!n.val){alert("State enthält keine Daten");return}const i=typeof n.val=="string"?JSON.parse(n.val):n.val;if(!Array.isArray(i)){alert("State enthält kein Array");return}const r=new Set;i.forEach(d=>{d.event&&typeof d.event=="string"&&r.add(d.event)});const o=Array.from(r).map(d=>({summary:d}));this.setState({uploadedEvents:o})}catch(n){console.error("Fehler beim Lesen des States:",n),alert(`Fehler: ${n.message}`)}};render(){var r;const{entry:s,oContext:a,theme:n}=this.props,{alive:i}=this.state;return e.jsxs(t.Box,{children:[e.jsx(t.Box,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:"action.hover"},children:e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:"text",label:this.getText("unique_label"),value:s.uniqueName,disabled:!i,onChange:o=>{const d=o.target.value;d.trim()&&this.props.onUniqueNameChange(s.uniqueName,d)},InputProps:{sx:{backgroundColor:"transparent",px:1,fontWeight:600,width:"50%"}}})}),e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:"text",autoComplete:"off",label:this.getText("headline"),value:s.headline??"",disabled:!i,onChange:o=>{this.handleFieldChange("headline",o.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1,width:"50%"}},sx:{mb:2}}),e.jsxs(t.Box,{sx:{mb:2},children:[e.jsx(t.Box,{sx:{display:"flex",alignItems:"center",mb:.5},children:e.jsx(t.Tooltip,{title:this.getText("trash_number_of_entities"),children:e.jsx(t.Typography,{variant:"caption",color:"text.secondary",sx:{mr:.5},children:"Layout"})})}),e.jsxs(t.Select,{size:"small",value:s.countItems||4,disabled:!i,onChange:o=>{this.handleFieldChange("countItems",o.target.value)},sx:{backgroundColor:"transparent",px:1},children:[e.jsx(t.MenuItem,{value:4,children:this.getText("trash_4_entities")}),e.jsx(t.MenuItem,{value:6,children:this.getText("trash_6_entities")})]})]}),e.jsx(t.Box,{sx:{mb:2},children:e.jsxs(t.FormControl,{component:"fieldset",children:[e.jsx(t.FormLabel,{component:"legend",children:this.getText("trash_import_type")}),e.jsxs(t.RadioGroup,{row:!0,value:s.trashImport,onChange:o=>{const d=o.target.value==="true";this.handleFieldChange("trashImport",d),this.setState({uploadedEvents:[]})},children:[e.jsx(t.FormControlLabel,{value:!0,control:e.jsx(t.Radio,{}),label:this.getText("trash_import_state"),disabled:!i}),e.jsx(t.FormControlLabel,{value:!1,control:e.jsx(t.Radio,{}),label:this.getText("trash_import_ics_file"),disabled:!i})]})]})}),s.trashImport&&e.jsxs(t.Box,{sx:{mb:2},children:[e.jsx(Q,{label:this.getText("trash_state"),value:s.trashState??"",onChange:o=>{this.handleFieldChange("trashState",o)},socket:a.socket,theme:n,themeType:((r=n==null?void 0:n.palette)==null?void 0:r.mode)||"light",dialogName:"selectTrashState",filterFunc:o=>!!(o&&o.type==="state"&&o._id&&o._id.startsWith("ical.")),disabled:!i}),e.jsx(t.Button,{variant:"text",startIcon:e.jsx($.SearchOutlined,{}),onClick:this.handleSearchClick,disabled:!i,sx:{minWidth:120,mt:1},children:this.getText("trash_search_events")}),this.state.uploadedEvents.length>0&&e.jsxs(t.Box,{sx:{mt:2},children:[e.jsx(t.FormLabel,{children:this.getText("trash_found_events")}),e.jsx(t.List,{sx:{maxHeight:300,overflow:"auto",border:1,borderColor:"divider",borderRadius:1,mt:1},children:this.state.uploadedEvents.map(o=>e.jsx(t.ListItem,{disablePadding:!0,children:e.jsxs(t.ListItemButton,{onClick:()=>this.handleToggleEvent(o.summary),disabled:!this.state.selectedEvents.includes(o.summary)&&this.state.selectedEvents.length>=6,children:[e.jsx(t.ListItemIcon,{children:e.jsx(t.Checkbox,{checked:this.state.selectedEvents.includes(o.summary),edge:"start"})}),e.jsx(t.ListItemText,{primary:o.summary})]})},o.summary))}),e.jsx(t.Button,{variant:"contained",onClick:this.handleApplySelection,disabled:!i||this.state.selectedEvents.length===0,sx:{mt:1},children:this.getText("trash_apply_selection")})]})]}),!s.trashImport&&e.jsxs(t.Box,{sx:{mb:2},children:[e.jsxs(t.Box,{sx:{display:"flex",gap:2,alignItems:"flex-end"},children:[e.jsx(t.TextField,{fullWidth:!0,variant:"standard",type:"text",autoComplete:"off",label:this.getText("trash_ics_file_path"),value:s.trashFile??"",disabled:!i,onChange:o=>{this.handleFieldChange("trashFile",o.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1}},helperText:this.getText("trash_ics_file_path_help")}),e.jsx(t.Button,{variant:"text",startIcon:e.jsx($.Upload,{}),onClick:this.handleUploadClick,disabled:!i,sx:{minWidth:120,mb:.5},children:this.getText("upload_file")})]}),e.jsx("input",{ref:this.fileInputRef,type:"file",accept:".ics",style:{display:"none"},onChange:this.handleFileSelect}),this.state.uploadedEvents.length>0&&e.jsxs(t.Box,{sx:{mt:2},children:[e.jsx(t.FormLabel,{children:this.getText("trash_select_events")}),e.jsx(t.List,{sx:{maxHeight:300,overflow:"auto",border:1,borderColor:"divider",borderRadius:1,mt:1},children:this.state.uploadedEvents.map(o=>e.jsx(t.ListItem,{disablePadding:!0,children:e.jsxs(t.ListItemButton,{onClick:()=>this.handleToggleEvent(o.summary),disabled:!this.state.selectedEvents.includes(o.summary)&&this.state.selectedEvents.length>=6,children:[e.jsx(t.ListItemIcon,{children:e.jsx(t.Checkbox,{checked:this.state.selectedEvents.includes(o.summary),edge:"start"})}),e.jsx(t.ListItemText,{primary:o.summary})]})},o.summary))}),e.jsx(t.Button,{variant:"contained",onClick:this.handleApplySelection,disabled:!i||this.state.selectedEvents.length===0,sx:{mt:1},children:this.getText("trash_apply_selection")})]})]}),e.jsx(t.Box,{sx:{mb:2},children:s.items.map((o,d)=>{var h;return e.jsxs(t.Box,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap",alignItems:"flex-end",p:2,border:1,borderColor:"divider",borderRadius:1},children:[e.jsx(t.TextField,{variant:"standard",type:"color",label:this.getText(`trash_color_field_${d+1}`),value:o.iconColor||"#d2d2d2",disabled:!i,onChange:l=>{this.handleItemChange(d,"iconColor",l.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1}},sx:{minWidth:100,flexShrink:0}}),e.jsx(t.Box,{sx:{flex:1,minWidth:220},children:e.jsx(se,{oContext:a,alive:i,changed:!1,themeName:((h=n==null?void 0:n.palette)==null?void 0:h.mode)==="dark"?"dark":"light",common:this.emptyCommon,attr:"icon",data:{icon:o.icon??""},originalData:{icon:o.icon??""},onError:()=>{},schema:{type:"custom",name:"IconSelect",url:"",label:`trash_icon_field_${d+1}`,i18n:!0},custom:!0,onChange:(l,c,p)=>{const T=this.getIconValueFromChange(l,c);this.handleItemChange(d,"icon",T),p&&p()},theme:n})}),e.jsx(t.TextField,{variant:"standard",type:"text",autoComplete:"off",label:this.getText(`trash_text_field_${d+1}`),value:o.textTrash||"",disabled:!i,onChange:l=>{this.handleItemChange(d,"textTrash",l.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1}},sx:{flex:1,minWidth:200}}),e.jsx(t.TextField,{variant:"standard",type:"text",autoComplete:"off",label:this.getText(`trash_custom_text_field_${d+1}`),value:o.customTrash||"",disabled:!i,onChange:l=>{this.handleItemChange(d,"customTrash",l.target.value)},InputProps:{sx:{backgroundColor:"transparent",px:1}},sx:{flex:1,minWidth:200}})]},`${s.uniqueName}-${d}`)})})]})}}class Pe extends D.ConfigGeneric{pagesRetryTimeout;constructor(s){super(s);const a=D.ConfigGeneric.getValue(s.data,s.attr);this.state={...this.state,entries:Array.isArray(a)?a:[],selected:"",selectedCardType:"all",pagesList:[],alive:!1,pagesRetryCount:0}}componentWillUnmount(){this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout);const s=this.props.oContext.instance??"0";this.props.oContext.socket.unsubscribeState(`system.adapter.${A}.${s}.alive`,this.onAliveChanged)}async componentDidMount(){super.componentDidMount();const s=this.props.oContext.instance??"0",a=`system.adapter.${A}.${s}.alive`;try{const n=await this.props.oContext.socket.getState(a),i=!!(n!=null&&n.val);this.setState({alive:i}),await this.props.oContext.socket.subscribeState(a,this.onAliveChanged),i&&await this.loadPagesList()}catch(n){console.error("[PageConfig] Failed to get alive state or subscribe:",n),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&(this.setState({alive:i}),!n&&i&&(!this.state.pagesList||this.state.pagesList.length===0)&&this.loadPagesList(),n&&!i&&this.pagesRetryTimeout&&(clearTimeout(this.pagesRetryTimeout),this.pagesRetryTimeout=void 0))};async loadPagesList(){if(!this.state.alive){console.log("[PageConfig] Adapter not alive, skipping pages load");return}const s=[];if(this.props.oContext&&this.props.oContext.socket){const a=this.props.oContext.instance??"0",n=`${A}.${a}`;try{const i=await this.props.oContext.socket.sendTo(n,ae,null);let r=[];Array.isArray(i)?r=i:i&&Array.isArray(i.result)&&(r=i.result);for(const o of r)s.push(o);if(r.length===0){const o=this.state.pagesRetryCount||0,d=3e3;console.log(`[PageConfig] Got empty pages array, retrying in ${d}ms (attempt ${o+1})`),this.setState({pagesRetryCount:o+1}),this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout),this.pagesRetryTimeout=setTimeout(()=>{this.state.alive?this.loadPagesList():console.log("[PageConfig] Adapter went offline, cancelling pages retry")},d);return}else r.length>0&&(console.log(`[PageConfig] Successfully loaded ${r.length} pages after ${this.state.pagesRetryCount||0} retries`),this.setState({pagesRetryCount:0}),this.pagesRetryTimeout&&(clearTimeout(this.pagesRetryTimeout),this.pagesRetryTimeout=void 0))}catch(i){const r=this.state.pagesRetryCount||0,o=3e3;console.log(`[PageConfig] Error loading pages, retrying in ${o}ms (attempt ${r+1}): ${String(i)}`),this.setState({pagesRetryCount:r+1}),this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout),this.pagesRetryTimeout=setTimeout(()=>{this.state.alive?this.loadPagesList():console.log("[PageConfig] Adapter went offline, cancelling pages retry after error")},o);return}}else{console.log("[PageConfig] No socket available for sendTo");return}this.setState({pagesList:Array.from(new Set(s))})}handleAdd=(s,a)=>{if(a==="all")return;let n;if(a==="cardAlarm")n={card:"cardAlarm",uniqueName:s,headline:s,button1:"",button2:"",button3:"",button4:"",button5:"",button6:"",button7:"",button8:"",pin:0};else if(a==="cardQR")n={card:"cardQR",uniqueName:s,headline:s,ssidUrlTel:"",wlanhidden:!1,pwdhidden:!1,setState:"",selType:0};else if(a==="cardTrash")n={card:"cardTrash",uniqueName:s,headline:s,countItems:4,trashImport:!0,trashState:"",trashFile:"",items:[{textTrash:"",customTrash:"",iconColor:"#3c3fff",icon:""},{textTrash:"",customTrash:"",iconColor:"#fffd77",icon:""},{textTrash:"",customTrash:"",iconColor:"#d2d2d2",icon:""},{textTrash:"",customTrash:"",iconColor:"#de8900",icon:""},{textTrash:"",customTrash:"",iconColor:"#d2d2d2",icon:""},{textTrash:"",customTrash:"",iconColor:"#d2d2d2",icon:""}]};else return;const i=[...this.state.entries,n];this.setState({entries:i}),this.onChange(this.props.attr,i)};handleDelete=s=>{const a=this.state.entries.filter(i=>i.uniqueName!==s);this.setState({entries:a}),this.onChange(this.props.attr,a);const n=Array.from(new Set(a.map(i=>i.uniqueName))).filter(Boolean);this.setState({selected:n[0]||""})};handleAssign=(s,a)=>{const n=this.state.entries.map(i=>i.uniqueName===s?{...i,navigationAssignment:a}:i);this.setState({entries:n}),this.onChange(this.props.attr,n)};handleEntryChange=s=>{const a=this.state.entries.map(n=>n.uniqueName===s.uniqueName?s:n);this.setState({entries:a}),this.onChange(this.props.attr,a)};handleUniqueNameChange=(s,a)=>{if(!a.trim())return;const n=this.state.entries.map(i=>i.uniqueName===s?{...i,uniqueName:a}:i);this.setState({entries:n,selected:a}),this.onChange(this.props.attr,n)};handleCardTypeChange=s=>{const a=s==="all"?this.state.entries:this.state.entries.filter(i=>i.card===s),n=a.length>0?a[0].uniqueName:"";this.setState({selectedCardType:s,selected:n})};handleCommonFieldsChange=(s,a)=>{const n=this.state.entries.map(i=>i.uniqueName===s?{...i,...a}:i);this.setState({entries:n}),this.onChange(this.props.attr,n)};renderMiddlePanel(){const{selected:s,entries:a,pagesList:n}=this.state;if(!s)return e.jsxs(t.Box,{children:[e.jsx(t.Typography,{variant:"h6",children:this.getText("select_item")}),e.jsx(t.Box,{sx:{mt:2},children:e.jsx(t.Typography,{variant:"body2",color:"text.secondary",children:this.getText("select_description")})})]});const i=a.find(r=>r.uniqueName===s);return i?i.card==="cardAlarm"?e.jsx(Se,{entry:i,pagesList:n,onEntryChange:this.handleEntryChange,onUniqueNameChange:this.handleUniqueNameChange,getText:r=>this.getText(r),oContext:this.props.oContext,theme:this.props.theme}):i.card==="cardQR"?e.jsx(Ie,{entry:i,onEntryChange:this.handleEntryChange,onUniqueNameChange:this.handleUniqueNameChange,getText:r=>this.getText(r),oContext:this.props.oContext,theme:this.props.theme}):i.card==="cardTrash"?e.jsx(_e,{entry:i,onEntryChange:this.handleEntryChange,onUniqueNameChange:this.handleUniqueNameChange,getText:r=>this.getText(r),oContext:this.props.oContext,theme:this.props.theme}):e.jsxs(t.Typography,{variant:"body2",children:[i.card," - ",this.getText("coming_soon")]}):e.jsx(t.Typography,{variant:"body2",color:"text.secondary",children:this.getText("Entry not found")})}renderItem(s,a,n){const i=this.state.entries.find(r=>r.uniqueName===this.state.selected);return e.jsx(je,{entries:this.state.entries,selected:this.state.selected,selectedCardType:this.state.selectedCardType,onSelectedChange:r=>this.setState({selected:r}),onCardTypeChange:this.handleCardTypeChange,onAdd:this.handleAdd,onDelete:this.handleDelete,onAssign:this.handleAssign,oContext:this.props.oContext,getText:r=>this.getText(r),navigationPanelProps:{...this.props,data:this.props.data,onChange:this.props.onChange,onError:this.props.onError,commonFields:i?{hidden:i.hidden,alwaysOn:i.alwaysOn,navigationAssignment:i.navigationAssignment}:void 0,onCommonFieldsChange:i?r=>{this.handleCommonFieldsChange(i.uniqueName,r)}:void 0},children:this.renderMiddlePanel()})}}const we=z(Pe),W={left:"◧",bottom:"⬜",indicator:"●",favorit:"💎",alternate:"⇄"};class ke extends B.Component{constructor(s){super(s);const a={type:"button",headline:"",modeScr:"left",data:{text:void 0,text1:void 0,icon:void 0,color:void 0,entity1:void 0,entity2:void 0,entity3:void 0,entity4:void 0,filter:void 0,setValue1:void 0,setValue2:void 0,setNavi:void 0,confirm:void 0,popup:void 0,enabled:void 0,additionalId:void 0,setTrue:!1,setFalse:!1}};this.state={editedItem:s.item?{...s.item}:a,confirmDeleteOpen:!1}}handleFieldChange=(s,a)=>{this.setState(n=>({editedItem:{...n.editedItem,[s]:a}}))};handleDataFieldChange=(s,a)=>{this.setState(n=>({editedItem:{...n.editedItem,data:{...n.editedItem.data,[s]:a||void 0}}}))};handleSave=()=>{this.props.onSave(this.state.editedItem)};handleDeleteClick=()=>{this.setState({confirmDeleteOpen:!0})};handleDeleteConfirm=()=>{this.setState({confirmDeleteOpen:!1}),this.props.onDelete&&this.props.onDelete()};handleDeleteCancel=()=>{this.setState({confirmDeleteOpen:!1})};render(){const{item:s,onBack:a,onDelete:n,getText:i,socket:r,theme:o,themeType:d}=this.props,{editedItem:h}=this.state,l=!s,c=h.modeScr==="indicator";return e.jsxs(t.Box,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",mb:3,gap:2},children:[e.jsx(t.IconButton,{onClick:a,sx:{color:"primary.main"},children:e.jsx($.ArrowBack,{})}),e.jsx(t.Typography,{variant:"h6",sx:{flex:1},children:i(l?"pageItem_new":"pageItem_edit")}),!l&&n&&e.jsx(t.IconButton,{onClick:this.handleDeleteClick,sx:{color:"error.main"},children:e.jsx($.Delete,{})})]}),e.jsx(t.Paper,{sx:{p:3,flex:1,overflow:"auto",display:"flex",flexDirection:"column"},children:e.jsxs(t.Box,{sx:{display:"flex",flexDirection:"column",gap:2,flex:1},children:[c&&e.jsxs(t.FormControl,{fullWidth:!0,children:[e.jsx(t.InputLabel,{children:i("pageItem_type")}),e.jsxs(t.Select,{value:h.type,label:i("pageItem_type"),onChange:p=>this.handleFieldChange("type",p.target.value),children:[e.jsx(t.MenuItem,{value:"button",children:i("pageItem_type_button")}),e.jsx(t.MenuItem,{value:"text",children:i("pageItem_type_text")})]})]}),e.jsx(t.TextField,{fullWidth:!0,label:i("pageItem_headline"),value:h.headline||"",onChange:p=>this.handleFieldChange("headline",p.target.value),helperText:i("pageItem_headline_hint")}),e.jsxs(t.FormControl,{fullWidth:!0,children:[e.jsx(t.InputLabel,{children:i("pageItem_modeScr")}),e.jsxs(t.Select,{value:h.modeScr||"left",label:i("pageItem_modeScr"),onChange:p=>{const T=p.target.value;this.handleFieldChange("modeScr",T),T!=="indicator"&&this.handleFieldChange("type","text")},children:[e.jsx(t.MenuItem,{value:"left",children:e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx("span",{style:{fontSize:"1.5rem"},children:W.left}),i("pageItem_modeScr_left")]})}),e.jsx(t.MenuItem,{value:"bottom",children:e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx("span",{style:{fontSize:"1.5rem"},children:W.bottom}),i("pageItem_modeScr_bottom")]})}),e.jsx(t.MenuItem,{value:"indicator",children:e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx("span",{style:{fontSize:"1.5rem"},children:W.indicator}),i("pageItem_modeScr_indicator")]})}),e.jsx(t.MenuItem,{value:"favorit",children:e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx("span",{style:{fontSize:"1.5rem"},children:W.favorit}),i("pageItem_modeScr_favorit")]})}),e.jsx(t.MenuItem,{value:"alternate",children:e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx("span",{style:{fontSize:"1.5rem"},children:W.alternate}),i("pageItem_modeScr_alternate")]})})]})]}),e.jsx(t.Divider,{}),e.jsx(t.Typography,{variant:"h6",sx:{mt:1},children:i("pageItem_data")}),!c&&e.jsx(t.TextField,{fullWidth:!0,label:i("pageItem_data_text"),value:h.data.text||"",onChange:p=>this.handleDataFieldChange("text",p.target.value),helperText:i("pageItem_data_text_hint")}),e.jsx(t.TextField,{fullWidth:!0,label:i("pageItem_data_icon"),value:h.data.icon||"",onChange:p=>this.handleDataFieldChange("icon",p.target.value),helperText:i("pageItem_data_icon_hint")}),e.jsx(Q,{label:i("pageItem_data_entity1"),value:h.data.entity1,onChange:p=>this.handleDataFieldChange("entity1",p),socket:r,theme:o,themeType:d||"light",dialogName:"nspanel-pageitem-editor-entity1"}),e.jsx(Q,{label:i("pageItem_data_entity2"),value:h.data.entity2,onChange:p=>this.handleDataFieldChange("entity2",p),socket:r,theme:o,themeType:d||"light",dialogName:"nspanel-pageitem-editor-entity2"}),e.jsx(t.TextField,{fullWidth:!0,label:i("pageItem_data_setNavi"),value:h.data.setNavi||"",onChange:p=>this.handleDataFieldChange("setNavi",p.target.value),helperText:i("pageItem_data_setNavi_hint")}),e.jsx(t.Box,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(t.Button,{variant:"contained",color:"primary",onClick:this.handleSave,children:i("save")})})]})}),e.jsx(Y,{open:this.state.confirmDeleteOpen,onClose:this.handleDeleteCancel,onConfirm:this.handleDeleteConfirm,title:i("pageItem_delete_confirm_title"),description:i("pageItem_delete_confirm_text"),cancelText:i("Cancel1"),confirmText:i("Delete"),ariaTitleId:"pageitem-delete-confirm-title",ariaDescId:"pageitem-delete-confirm-description"})]})}}class Ae extends D.ConfigGeneric{_local=null;pagesRetryTimeout;dateFormats=[{value:{dateStyle:"short"},label:"dateFormatShort"},{value:{year:"numeric",month:"2-digit",day:"2-digit"},label:"dateFormatYearMonthDay"},{value:{day:"2-digit",month:"short",year:"numeric"},label:"dateFormatDayShortMonthYear"},{value:{day:"2-digit",month:"long",year:"numeric"},label:"dateFormatDayLongMonthYear"},{value:{weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"},label:"dateFormatWeekdayShortDate"},{value:{weekday:"long",day:"2-digit",month:"2-digit",year:"numeric"},label:"dateFormatWeekdayLongDate"},{value:{weekday:"short",day:"2-digit",month:"short",year:"numeric"},label:"dateFormatWeekdayShortDayMonthYear"},{value:{weekday:"long",day:"2-digit",month:"long",year:"numeric"},label:"dateFormatWeekdayLongDayMonthYear"},{value:"custom",label:"Custom"}];timeFormats=[{value:{hour:"2-digit",minute:"2-digit",hour12:!1},label:"timeFormat24"},{value:{hour:"numeric",minute:"2-digit",hour12:!0},label:"timeFormat12"}];constructor(s){super(s);const a=D.ConfigGeneric.getValue(s.data,s.attr);this.state={...this.state,entries:Array.isArray(a)?a:[],confirmDeleteOpen:!1,confirmDeleteName:null,alive:!1,pagesRetryCount:0}}formatDatePreview(s,a){try{return s.toLocaleDateString(void 0,typeof a=="string"?JSON.parse(a):a)}catch{return"Invalid Format"}}formatTimePreview(s,a){try{return s.toLocaleTimeString(void 0,typeof a=="string"?JSON.parse(a):a)}catch{return"Invalid Format"}}componentWillUnmount(){this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout);const s=this.props.oContext.instance??"0";this.props.oContext.socket.unsubscribeState(`system.adapter.${A}.${s}.alive`,this.onAliveChanged)}async componentDidMount(){super.componentDidMount();const s=this.props.oContext.instance??"0",a=`system.adapter.${A}.${s}.alive`;try{const n=await this.props.oContext.socket.getState(a),i=!!(n!=null&&n.val);this.setState({alive:i}),await this.props.oContext.socket.subscribeState(a,this.onAliveChanged),i&&await this.loadPagesList()}catch(n){console.error("[ScreensaverPage] Failed to get alive state or subscribe:",n),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&(this.setState({alive:i}),!n&&i&&(!this.state.pagesList||this.state.pagesList.length===0)&&this.loadPagesList(),n&&!i&&this.pagesRetryTimeout&&(clearTimeout(this.pagesRetryTimeout),this.pagesRetryTimeout=void 0))};async loadPagesList(){if(!this.state.alive){console.log("[ScreensaverPage] Adapter not alive, skipping pages load");return}const s=[];if(this.props.oContext&&this.props.oContext.socket){const a=this.props.oContext.instance??"0",n=`${A}.${a}`;try{const i=await this.props.oContext.socket.sendTo(n,ae,null);let r=[];Array.isArray(i)?r=i:i&&Array.isArray(i.result)&&(r=i.result);for(const o of r)s.push(o);if(r.length===0){const o=this.state.pagesRetryCount||0,d=3e3;console.log(`[ScreensaverPage] Got empty pages array, retrying in ${d}ms (attempt ${o+1})`),this.setState({pagesRetryCount:o+1}),this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout),this.pagesRetryTimeout=setTimeout(()=>{this.state.alive?this.loadPagesList():console.log("[ScreensaverPage] Adapter went offline, cancelling pages retry")},d);return}else r.length>0&&(console.log(`[ScreensaverPage] Successfully loaded ${r.length} pages after ${this.state.pagesRetryCount||0} retries`),this.setState({pagesRetryCount:0}),this.pagesRetryTimeout&&(clearTimeout(this.pagesRetryTimeout),this.pagesRetryTimeout=void 0))}catch(i){const r=this.state.pagesRetryCount||0,o=3e3;console.log(`[ScreensaverPage] Error loading pages, retrying in ${o}ms (attempt ${r+1}): ${String(i)}`),this.setState({pagesRetryCount:r+1}),this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout),this.pagesRetryTimeout=setTimeout(()=>{this.state.alive?this.loadPagesList():console.log("[ScreensaverPage] Adapter went offline, cancelling pages retry after error")},o);return}}else{console.log("[ScreensaverPage] No socket available for sendTo");return}this.setState({pagesList:Array.from(new Set(s))})}renderItem(s,a,n){var C,w,v,g,j,b,N,x,q,E,Z,K;const i=this.state.entries||[],r=Array.from(new Set(i.map(m=>m.uniqueName))).filter(Boolean);this._local||(this._local={newName:"",selected:r[0]||""});const o=this._local,d=()=>{const m=(o.newName||"").trim();if(!m)return;const u={card:"screensaver",uniqueName:m,pageItems:[]},_=[...i,u];this.setState({entries:_}),this.onChange(this.props.attr,_),o.newName="",o.selected=m},h=()=>{const m=o.selected;m&&this.setState({confirmDeleteOpen:!0,confirmDeleteName:m})},l=()=>{this.setState({confirmDeleteOpen:!1,confirmDeleteName:null})},c=()=>{const m=this.state.confirmDeleteName;if(!m){l();return}const u=i.filter(F=>F.uniqueName!==m);this.setState({entries:u,confirmDeleteOpen:!1,confirmDeleteName:null}),this.onChange(this.props.attr,u);const _=Array.from(new Set(u.map(F=>F.uniqueName))).filter(Boolean);o&&(o.selected=_[0]||""),this.setState({})},p=this.state.editingPageItem!==void 0,T=p?0:30;return e.jsxs(t.Box,{sx:{height:"calc(100vh - 64px)",display:"flex",flexDirection:{xs:"column",md:"row"},p:1,overflow:"hidden"},children:[e.jsxs(t.Box,{sx:{width:{xs:"100%",md:"20%"},pr:{xs:0,md:1},display:"flex",flexDirection:"column",gap:1,minHeight:100,overflow:"auto"},children:[e.jsx(t.Typography,{variant:"h6",sx:{mb:.5,fontWeight:600,color:"primary.main",fontSize:"1rem",flexShrink:0},children:this.getText("screensaver_pages")}),e.jsx(t.Paper,{sx:{p:1,backgroundColor:"transparent",flexShrink:0},elevation:0,children:e.jsxs(t.Box,{sx:{display:"flex",gap:1},children:[e.jsx(t.TextField,{"aria-label":"new-screensaver-name",label:this.getText("new_screensaver"),value:(o==null?void 0:o.newName)||"",onChange:m=>{o&&(o.newName=m.target.value),this.setState({})},variant:"standard",placeholder:this.getText("new_screensaver"),InputProps:{sx:{backgroundColor:"transparent",px:1}},sx:{flex:1,"& .MuiInput-underline:before":{borderBottomColor:"primary.main"},"& .MuiInput-underline:hover:before":{borderBottomColor:"primary.main"},"& .MuiInput-underline:after":{borderBottomColor:"primary.main"},"& .MuiInputLabel-root":{color:"primary.main"},"& .MuiInputLabel-root.Mui-focused":{color:"primary.main"}}}),e.jsx(t.Button,{size:"small",variant:"contained",onClick:d,sx:{minWidth:32,padding:"4px 8px"},disabled:(()=>{const m=((o==null?void 0:o.newName)||"").trim();return!m||r.includes(m)})(),children:"+"})]})}),e.jsx(t.Paper,{sx:{overflow:"auto",p:1,backgroundColor:"transparent",flex:1,minHeight:"50px",maxHeight:"100px"},elevation:1,children:r.length===0?e.jsx(t.Typography,{variant:"body2",color:"text.secondary",children:this.getText("no_screensavers")}):r.map(m=>e.jsx(t.Box,{onClick:()=>{o&&(o.selected=m),this.setState({})},sx:{p:1,borderRadius:1,cursor:"pointer",backgroundColor:(o==null?void 0:o.selected)===m?"action.selected":"transparent",mb:.5},children:e.jsx(t.Typography,{variant:"body2",children:m})},m))}),e.jsx(t.Box,{sx:{display:"flex",justifyContent:"flex-end",flexShrink:0},children:e.jsx(t.Button,{size:"small",color:"error",variant:"outlined",sx:{minWidth:32,padding:"4px 8px"},onClick:h,disabled:!(o!=null&&o.selected),children:"-"})}),e.jsxs(t.Box,{sx:{flex:1,minHeight:0},children:[e.jsx(t.Box,{sx:{marginTop:1,marginBottom:1},children:e.jsxs(t.FormControl,{component:"fieldset",disabled:(o==null?void 0:o.selected)===null,children:[e.jsx(t.FormLabel,{component:"legend",sx:{color:(o==null?void 0:o.selected)===null?((v=(w=(C=this.props.theme)==null?void 0:C.palette)==null?void 0:w.text)==null?void 0:v.disabled)||"#999":(b=(j=(g=this.props.theme)==null?void 0:g.palette)==null?void 0:j.text)==null?void 0:b.primary},children:this.getText("cardType")}),e.jsxs(t.RadioGroup,{value:o!=null&&o.selected&&((N=this.state.entries.find(m=>m.uniqueName===o.selected))==null?void 0:N.card)||"screensaver",onChange:m=>{if(o!=null&&o.selected){const u=m.target.value,_=[...this.state.entries],F=_.findIndex(V=>V.uniqueName===o.selected);F!==-1&&(_[F]={..._[F],card:u},this.setState({entries:_}),this.props.onChange(this.props.attr||"",_))}},sx:{flexDirection:"column","& .MuiRadio-root.Mui-disabled":{color:"#999 !important"},"& .MuiFormControlLabel-label.Mui-disabled":{color:"#999 !important"}},children:[e.jsx(t.FormControlLabel,{value:"screensaver",control:e.jsx(t.Radio,{}),label:this.getText("cardTypeStandard")}),e.jsx(t.FormControlLabel,{value:"screensaver2",control:e.jsx(t.Radio,{}),label:this.getText("cardTypeAdvanced")}),e.jsx(t.FormControlLabel,{value:"screensaver3",control:e.jsx(t.Radio,{}),label:this.getText("cardTypeEasyview")})]})]})}),e.jsx(t.Divider,{sx:{my:1}}),e.jsx(t.Box,{sx:{mb:2},children:e.jsx("a",{href:"https://github.com/ticaki/ioBroker.nspanel-lovelace-ui/wiki/screensaver",target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none",color:"inherit",fontSize:"0.875rem"},children:e.jsx(t.Typography,{variant:"body2",sx:{color:"primary.main",textDecoration:"underline",cursor:"pointer","&:hover":{opacity:.8}},children:this.getText("documentation")})})}),e.jsxs(t.Box,{sx:{mb:2,display:"flex",gap:1,alignItems:"center"},children:[e.jsx(t.TextField,{fullWidth:!0,label:"Select Object ID (custom)",value:this.state.selectedObjectId||"",onChange:m=>{this.setState({selectedObjectId:m.target.value})},variant:"standard"}),e.jsx(t.Button,{variant:"outlined",onClick:()=>this.setState({showSelectDialog:!0}),sx:{minWidth:48},children:"..."}),this.state.showSelectDialog&&e.jsx(y.SelectID,{socket:this.props.oContext.socket,selected:this.state.selectedObjectId||"",onOk:m=>{const u=Array.isArray(m)?m[0]:m;this.setState({selectedObjectId:u||"",showSelectDialog:!1})},onClose:()=>{this.setState({showSelectDialog:!1})},filterFunc:m=>{var u;return!!((m==null?void 0:m.type)==="state"&&((u=m.common)!=null&&u.role)&&m.common.role.startsWith("switch"))},dialogName:"nspanel-screensaver",theme:this.props.theme,themeType:((q=(x=this.props.theme)==null?void 0:x.palette)==null?void 0:q.mode)||"light"})]}),e.jsxs(t.Box,{sx:{mb:2},children:[e.jsx(t.Typography,{variant:"caption",sx:{display:"flex",mb:1,color:"text.secondary"},children:"Test 2: JsonConfigComponent (filterFunc = string compiled with new Function)"}),e.jsx(D.JsonConfigComponent,{socket:this.props.oContext.socket,themeName:this.props.themeName,themeType:((Z=(E=this.props.theme)==null?void 0:E.palette)==null?void 0:Z.mode)||"light",theme:this.props.theme,schema:{type:"panel",label:"Object Selector",items:{testObjectId:{type:"objectId",label:"Select Object (JsonConfig)",sm:12,md:12,lg:12,filterFunc:"return !!(obj?.type === 'state' && obj.common?.role && obj.common.role.startsWith('switch'));"}}},data:{testObjectId:this.state.selectedObjectIdJson||""},onChange:m=>{const u=m&&m.testObjectId||"";this.setState({selectedObjectIdJson:u})},isFloatComma:!1,dateFormat:"DD.MM.YYYY",onError:()=>{},adapterName:"nspanel-lovelace-ui",instance:Number(((K=this.props.oContext)==null?void 0:K.instance)||0)})]})]})]}),e.jsx(Y,{open:!!this.state.confirmDeleteOpen,onClose:l,onConfirm:c,title:this.getText("screensaver_delete_confirm_title"),description:this.getText("screensaver_delete_confirm_text")+(this.state.confirmDeleteName?`: ${this.state.confirmDeleteName}`:""),cancelText:this.getText("Cancel1"),confirmText:this.getText("Delete"),ariaTitleId:"screensaver-delete-confirm-title",ariaDescId:"screensaver-delete-confirm-description"}),e.jsxs(t.Box,{sx:{width:{xs:"100%",md:"100%"},pl:{xs:0,md:2},mt:{xs:2,md:0},display:"flex",flexDirection:{xs:"column",md:"row"},gap:1,position:"relative",minHeight:0,overflow:"hidden"},children:[e.jsx(t.Box,{sx:{width:{xs:"100%",md:"100%"},borderLeft:{xs:"none",md:"1px solid"},borderColor:"divider",display:"flex",flexDirection:"column",minHeight:0},children:e.jsx(t.Paper,{sx:{height:"100%",p:2,display:"flex",flexDirection:"column",overflow:"auto"},elevation:1,children:o!=null&&o.selected?e.jsx(t.Box,{children:(()=>{var _,F,V;const m=o==null?void 0:o.selected,u=i.find(f=>f.uniqueName===m);return u?e.jsxs(t.Box,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(t.Typography,{variant:"h6",sx:{mb:1},children:[this.getText("screensaver_config"),": ",m]}),this.state.editingPageItem!==void 0?e.jsx(ke,{item:this.state.editingPageItem,onSave:f=>{const P=u.pageItems||[];let S;this.state.editingPageItemIndex!==void 0?S=P.map((L,oe)=>oe===this.state.editingPageItemIndex?f:L):S=[...P,f];const I=i.map(L=>L.uniqueName===m?{...L,pageItems:S}:L);this.setState({entries:I,editingPageItem:void 0,editingPageItemIndex:void 0}),this.onChange(this.props.attr,I)},onDelete:()=>{if(this.state.editingPageItemIndex!==void 0){const P=(u.pageItems||[]).filter((I,L)=>L!==this.state.editingPageItemIndex),S=i.map(I=>I.uniqueName===m?{...I,pageItems:P}:I);this.setState({entries:S,editingPageItem:void 0,editingPageItemIndex:void 0}),this.onChange(this.props.attr,S)}},onBack:()=>{this.setState({editingPageItem:void 0,editingPageItemIndex:void 0})},getText:f=>this.getText(f),socket:this.props.oContext.socket,theme:this.props.theme,themeName:this.props.themeName,themeType:((F=(_=this.props.theme)==null?void 0:_.palette)==null?void 0:F.mode)||"light",instance:Number(((V=this.props.oContext)==null?void 0:V.instance)||0)}):e.jsxs(e.Fragment,{children:[e.jsxs(t.FormControl,{variant:"outlined",fullWidth:!0,sx:{mt:2},children:[e.jsx(t.InputLabel,{children:this.getText("dateFormat")}),e.jsx(t.Select,{value:u.dateFormat||"dd.MM.yyyy",onChange:f=>{const P=f.target.value,S=i.map(I=>I.uniqueName===m?{...I,dateFormat:P}:I);this.setState({entries:S}),this.onChange(this.props.attr,S)},label:this.getText("dateFormat"),children:this.dateFormats.map(f=>e.jsx(t.MenuItem,{value:JSON.stringify(f.value),children:f.value==="custom"?this.getText("dateFormatCustom"):this.getText(f.label)},f.label))})]}),u.dateFormat==='"custom"'&&e.jsx(t.TextField,{label:this.getText("dateFormatCustom"),value:u.customDateFormat||"",onChange:f=>{const P=f.target.value,S=i.map(I=>I.uniqueName===m?{...I,customDateFormat:P}:I);this.setState({entries:S}),this.onChange(this.props.attr,S)},variant:"outlined",fullWidth:!0,placeholder:'{ "weekday": "long", "day": "2-digit", "month": "2-digit", "year": "numeric" }',sx:{mt:1}}),e.jsxs(t.Typography,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:[this.getText("dateFormatExample"),":"," ",(()=>{const f=new Date,P=u.dateFormat||"dd.MM.yyyy";console.log("Formatting date with format:",u.dateFormat);try{if(P==='"custom"'){const S=u.customDateFormat||"";return S?(console.log("Formatting date with custom:",S),this.formatDatePreview(f,S)):"Enter custom format above"}return this.formatDatePreview(f,P)}catch{return"Invalid format"}})()]}),e.jsxs(t.FormControl,{variant:"outlined",fullWidth:!0,sx:{mt:2},children:[e.jsx(t.InputLabel,{children:this.getText("timeFormat")}),e.jsx(t.Select,{value:u.timeFormat||JSON.stringify({hour:"2-digit",minute:"2-digit",hour12:!1}),onChange:f=>{const P=f.target.value,S=i.map(I=>I.uniqueName===m?{...I,timeFormat:P}:I);this.setState({entries:S}),this.onChange(this.props.attr,S)},label:this.getText("timeFormat"),children:this.timeFormats.map(f=>e.jsx(t.MenuItem,{value:JSON.stringify(f.value),children:this.getText(f.label)},f.label))})]}),e.jsxs(t.Typography,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:[this.getText("timeFormatExample"),":"," ",(()=>{const f=new Date,P=u.timeFormat||JSON.stringify({hour:"2-digit",minute:"2-digit",hour12:!1});try{return this.formatTimePreview(f,P)}catch{return"Invalid format"}})()]}),e.jsx(t.Divider,{sx:{my:3}}),e.jsx(t.Typography,{variant:"h6",sx:{mb:2},children:this.getText("pageItems")}),e.jsxs(t.Box,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(80px, 1fr))",gap:2,mt:2},children:[e.jsxs(t.Box,{onClick:()=>{this.setState({editingPageItem:null,editingPageItemIndex:void 0})},sx:{display:"flex",flexDirection:"column",alignItems:"center",cursor:"pointer","&:hover":{opacity:.8}},children:[e.jsx(t.Box,{sx:{width:60,height:60,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:1,backgroundColor:"success.main",color:"white",fontSize:"2.5rem",fontWeight:"bold",mb:1},children:"+"}),e.jsx(t.Typography,{variant:"caption",sx:{textAlign:"center",fontSize:"0.75rem"},children:this.getText("add")})]}),(u.pageItems||[]).map((f,P)=>{const S=f.modeScr&&W[f.modeScr]?W[f.modeScr]:"?";return e.jsxs(t.Box,{onClick:()=>{this.setState({editingPageItem:f,editingPageItemIndex:P})},sx:{display:"flex",flexDirection:"column",alignItems:"center",cursor:"pointer","&:hover":{opacity:.8}},children:[e.jsx(t.Box,{sx:{width:60,height:60,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:1,backgroundColor:"action.hover",color:"primary.main",fontSize:"2rem",mb:1},children:S}),e.jsx(t.Typography,{variant:"caption",sx:{textAlign:"center",fontSize:"0.75rem"},children:f.headline||"Item"})]},P)})]})]})]}):e.jsx(t.Typography,{variant:"body2",color:"error",children:this.getText("screensaver_entry_not_found")})})()}):e.jsxs(t.Box,{children:[e.jsx(t.Typography,{variant:"h6",children:this.getText("screensaver_select_item")}),e.jsx(t.Box,{sx:{mt:2},children:e.jsx(t.Typography,{variant:"body2",color:"text.secondary",children:this.getText("screensaver_select_description")})})]})})}),e.jsx(t.Box,{sx:{width:{xs:"100%",md:`${T}%`},transition:"width 300ms ease",overflow:p?"hidden":"visible",display:p?{xs:"none",md:"block"}:"block"},children:e.jsx(ne,{...this.props,widthPercent:30,oContext:this.props.oContext,uniqueName:(o==null?void 0:o.selected)||"",currentAssignments:(()=>{const m=o==null?void 0:o.selected;if(!m)return[];const u=i.find(_=>_.uniqueName===m);return(u==null?void 0:u.navigation)||[]})(),onAssign:(m,u)=>{const _=i.map(F=>F.uniqueName===m?{...F,navigation:u}:F);this.setState({entries:_}),this.onChange(this.props.attr,_)},hideNavigationFields:!0})})]})]})}}const Fe=z(Ae);class Ne extends D.ConfigGeneric{pagesRetryTimeout;adapterName=this.props.oContext.adapterName;instance=this.props.oContext.instance??"0";constructor(s){super(s),this.state={...this.state,alive:!1,weatherEntities:[],loadingWeather:!1}}componentWillUnmount(){this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout),this.props.oContext.socket.unsubscribeState(`system.adapter.${this.adapterName}.${this.instance}.alive`,this.onAliveChanged)}async componentDidMount(){super.componentDidMount();const s=`system.adapter.${this.adapterName}.${this.instance}.alive`;try{const a=await this.props.oContext.socket.getState(s),n=!!(a!=null&&a.val);this.setState({alive:n}),await this.props.oContext.socket.subscribeState(s,this.onAliveChanged),n&&await this.loadWeatherEntities(!1)}catch(a){console.error("[PageGlobalSettings] Failed to get alive state or subscribe:",a),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&this.setState({alive:i})};async loadWeatherEntities(s=!1){var i,r;if(!this.state.alive)return;const a=Date.now(),n=this.state.lastWeatherLoad||0;if(!s&&a-n<6e4&&((i=this.state.weatherEntities)!=null&&i.length)){console.log("[PageGlobalSettings] Using cached weather entities, last load:",new Date(n));return}if(console.log("[PageGlobalSettings] Loading weather entities, forceReload:",s),this.setState({loadingWeather:!0}),this.props.oContext.socket){const o=`${this.adapterName}.${this.instance}`,d={internalServerIp:(r=this.props.data)==null?void 0:r.internalServerIp};try{const h=new Promise((T,C)=>{setTimeout(()=>C(new Error("sendTo timeout after 2 seconds")),2e3)}),l=this.props.oContext.socket.sendTo(o,"getWeatherEntity",d),c=await Promise.race([l,h]);let p=[];Array.isArray(c)?p=c:c&&Array.isArray(c.result)&&(p=c.result),console.log("[PageGlobalSettings] sendTo successful",{target:o,entities:p}),this.setState({weatherEntities:p,lastWeatherLoad:a,loadingWeather:!1})}catch(h){console.error("[PageGlobalSettings] Failed to load weather entities",{target:o,cmd:"getWeatherEntity",payload:d,error:h}),this.setState({weatherEntities:[],loadingWeather:!1})}}}handleCheckboxChange=s=>a=>{this.onChange(s,a.target.checked)};handleSelectStringChange=s=>a=>{this.onChange(s,a.target.value)};handleSelectNumberChange=s=>a=>{this.onChange(s,a.target.value)};handleTextChange=s=>a=>{this.onChange(s,a.target.value)};validateServicePin=s=>s===""||/^[0-9]+$/.test(s);handleServicePinChange=s=>{const a=s.target.value;this.validateServicePin(a)&&this.onChange("pw1",a)};renderItem(s,a,n){const{alive:i}=this.state,r=this.props.data||{},o=r.useBetaTFT??!1,d=r.colorTheme??0,h=r.weekdayFormat??!1,l=r.monthFormat??0,c=r.yearFormat??!1,p=r.shutterClosedIsZero??!1,T=r.defaultValueCardThermo??!1,C=r.pw1??"",w=r.rememberLastSite??!1,v=r.weatherEntity??"",g=r.writeTasmotaTele??!1,j=this.props.expertMode??!1,b={p:2,border:2,borderColor:"divider",borderRadius:1,height:"100%"};return e.jsxs(t.Box,{sx:{p:2,display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",md:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2,width:"100%"},children:[e.jsxs(t.Box,{sx:{...b,borderColor:o?"error.main":"divider"},children:[e.jsx(t.Typography,{variant:"h6",gutterBottom:!0,sx:{color:o?"error.main":"inherit"},children:this.getText("headeruseBetaTFT")}),e.jsx(t.Tooltip,{title:this.getText("useBetaVersionTooltip"),arrow:!0,placement:"top",children:e.jsx("span",{children:e.jsx(t.FormControlLabel,{sx:{color:o?"error.main":"inherit"},control:e.jsx(t.Checkbox,{checked:o,onChange:this.handleCheckboxChange("useBetaTFT"),disabled:!i||!j}),label:this.getText("useBetaVersion")})})})]}),e.jsxs(t.Box,{sx:b,children:[e.jsx(t.Typography,{variant:"h6",gutterBottom:!0,children:this.getText("headerColorTheme")}),e.jsx(t.FormControl,{sx:{m:1,minWidth:120},size:"small",disabled:!i,children:e.jsxs(t.Select,{id:"color-theme-select",value:d,label:this.getText("colorTheme"),onChange:this.handleSelectNumberChange("colorTheme"),children:[e.jsx(t.MenuItem,{value:0,children:this.getText("default")}),e.jsx(t.MenuItem,{value:1,children:this.getText("tropical")}),e.jsx(t.MenuItem,{value:2,children:this.getText("technical")}),e.jsx(t.MenuItem,{value:3,children:this.getText("sunset")}),e.jsx(t.MenuItem,{value:4,children:this.getText("vulcano")}),e.jsx(t.MenuItem,{value:5,children:this.getText("userColors")})]})})]}),e.jsxs(t.Box,{sx:b,children:[e.jsx(t.Typography,{variant:"h6",gutterBottom:!0,children:this.getText("headerWeatherEntity")}),e.jsxs(t.FormControl,{sx:{m:1,minWidth:200},size:"small",disabled:!i,children:[e.jsx(t.InputLabel,{id:"weather-entity-label",children:this.getText("weatherEntityLabel")}),e.jsxs(t.Select,{labelId:"weather-entity-label",id:"weather-entity-select",value:v,label:this.getText("weatherEntityLabel"),onOpen:()=>{this.loadWeatherEntities(!0)},onChange:this.handleSelectStringChange("weatherEntity"),disabled:!i||this.state.loadingWeather,children:[this.state.loadingWeather&&e.jsx(t.MenuItem,{disabled:!0,value:"",children:e.jsx(t.CircularProgress,{size:16})}),(this.state.weatherEntities||[]).map(N=>e.jsx(t.MenuItem,{value:N.value,children:N.label},N.value||N.label))]})]})]}),e.jsxs(t.Box,{sx:b,children:[e.jsx(t.Typography,{variant:"h6",gutterBottom:!0,children:this.getText("headerDateFormat")}),e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:h,onChange:this.handleCheckboxChange("weekdayFormat"),disabled:!i}),label:this.getText("longWeekdayName")}),e.jsxs(t.FormControl,{sx:{m:1,minWidth:120},size:"small",disabled:!i,children:[e.jsx(t.InputLabel,{id:"MonthFormat-label",children:this.getText("MonthFormat")}),e.jsxs(t.Select,{labelId:"MonthFormat-label",id:"MonthFormat-select",value:l,label:this.getText("MonthFormat"),onChange:this.handleSelectNumberChange("monthFormat"),children:[e.jsx(t.MenuItem,{value:0,children:this.getText("long")}),e.jsx(t.MenuItem,{value:1,children:this.getText("short")}),e.jsx(t.MenuItem,{value:2,children:this.getText("numeric")})]})]}),e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:c,onChange:this.handleCheckboxChange("yearFormat"),disabled:!i}),label:this.getText("longYear")})]}),e.jsxs(t.Box,{sx:b,children:[e.jsx(t.Typography,{variant:"h6",gutterBottom:!0,children:this.getText("headerShutter")}),e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:p,onChange:this.handleCheckboxChange("shutterClosedIsZero"),disabled:!i}),label:this.getText("shutterClosedIsZero")})]}),e.jsxs(t.Box,{sx:b,children:[e.jsx(t.Typography,{variant:"h6",gutterBottom:!0,children:this.getText("headerCardThermo")}),e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:T,onChange:this.handleCheckboxChange("defaultValueCardThermo"),disabled:!i}),label:this.getText("defaultValueCardThermo")}),e.jsx(t.FormHelperText,{children:this.getText("defaultValueCardThermoHint")})]}),e.jsxs(t.Box,{sx:b,children:[e.jsx(t.Typography,{variant:"h6",gutterBottom:!0,children:"Service-Pin"}),e.jsx(t.TextField,{id:"service-pin-input",type:"password",value:C,onChange:this.handleServicePinChange,disabled:!i,helperText:this.getText("mustBeNumber"),error:!this.validateServicePin(C),slotProps:{input:{inputMode:"numeric"}}})]}),e.jsxs(t.Box,{sx:b,children:[e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:w,onChange:this.handleCheckboxChange("rememberLastSite"),disabled:!i}),label:this.getText("rememberLastSite")}),e.jsx(t.FormHelperText,{children:this.getText("rememberLastSiteHint")})]}),e.jsxs(t.Box,{sx:b,children:[e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:g,onChange:this.handleCheckboxChange("writeTasmotaTele"),disabled:!i}),label:this.getText("writeTasmotaTele")}),e.jsx(t.FormHelperText,{children:this.getText("writeTasmotaTeleHint")})]})]})}}const De=z(Ne);class Be extends D.ConfigGeneric{confirmDialog=null;timeoutHandle=null;instance=this.props.oContext.instance??"0";adapterName=this.props.oContext.adapterName;constructor(s){super(s),this.state={...this.state,panels:[],loading:!1,error:null,processingPanel:null,alive:!1}}componentWillUnmount(){const s=`system.adapter.${this.adapterName}.${this.instance}.alive`;this.props.oContext.socket.unsubscribeState(s,this.onAliveChanged);for(const a of this.props.data.panels)this.props.oContext.socket.unsubscribeState(`${this.adapterName}.${this.instance}.panels.${a.id}.info.isOnline`,this.onPanelOnlineChanged);this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=null)}async componentDidMount(){super.componentDidMount();const s=`system.adapter.${this.adapterName}.${this.instance}.alive`;try{const a=await this.props.oContext.socket.getState(s),n=!!(a!=null&&a.val);this.setState({alive:n}),await this.props.oContext.socket.subscribeState(s,this.onAliveChanged),n&&(console.log("[Maintain] Adapter is alive, ready to load settings."),await this.refreshPanels());for(const i of this.props.data.panels)console.log(`[Maintain] Subscribing to online state for panel ${i.name} (${i.id})`),await this.props.oContext.socket.subscribeState(`${this.adapterName}.${this.instance}.panels.${i.id}.info.isOnline`,this.onPanelOnlineChanged)}catch(a){console.error("[Maintain] Failed to get alive state or subscribe:",a),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&(console.log("[Maintain] Alive state changed:",{wasAlive:n,isAlive:i}),this.setState({alive:i}))};onPanelOnlineChanged=(s,a)=>{console.log("[Maintain] Panel online state changed, refreshing panels"),this.refreshPanels(),this.timeoutHandle&&clearTimeout(this.timeoutHandle),this.timeoutHandle=setTimeout(()=>{this.refreshPanels()},5e3)};async refreshPanels(){if(!this.state.alive){this.setState({error:this.getText("adapterNotAlive"),loading:!1});return}this.setState({loading:!0,error:null});try{const s=await this.props.oContext.socket.sendTo(`${this.adapterName}.${this.instance}`,"refreshMaintainTable",{internalServerIp:this.props.data.internalServerIp});console.log("[Maintain] refreshMaintainTable result:",s),s&&s.native&&Array.isArray(s.native._maintainPanels)?this.setState({panels:s.native._maintainPanels,loading:!1}):this.setState({error:this.getText("invalidResponseFromAdapter"),loading:!1})}catch(s){this.setState({error:String(s),loading:!1});return}}showConfirmDialog(s,a,n){this.confirmDialog={open:!0,title:s,text:a,onConfirm:n},this.forceUpdate()}closeConfirmDialog(){this.confirmDialog=null,this.forceUpdate()}handleTasmotaUpdate(s){this.showConfirmDialog(this.getText("tasmotaUpdate"),this.getText("updateTasmotaText"),async()=>{this.closeConfirmDialog(),this.setState({processingPanel:s._name});try{this.onPanelOnlineChanged("",null);const a=await this.props.oContext.socket.sendTo(`${this.adapterName}.${this.instance}`,"updateTasmota",{topic:s._topic});a&&typeof a=="object"&&"error"in a?this.setState({error:String(a.error),processingPanel:null}):(await this.refreshPanels(),this.setState({processingPanel:null}))}catch(a){this.setState({error:String(a),processingPanel:null})}})}handleTftInstall(s){this.showConfirmDialog(this.getText("tftInstallSendToMQTT"),`${this.getText("tftInstallSendToMQTTText")}

Panel: ${s._name}
TFT - Version: ${s._tftVersion}`,async()=>{this.closeConfirmDialog(),this.setState({processingPanel:s._name});try{console.log("[Maintain] Sending TFT install command to MQTT for panel:",s._name),this.onPanelOnlineChanged("",null);const a=await this.props.oContext.socket.sendTo(`${this.adapterName}.${this.instance}`,"tftInstallSendToMQTT",{tasmotaIP:s._ip,topic:s._topic,internalServerIp:this.props.data.internalServerIp,useBetaTFT:this.props.data.useBetaTFT||!1,online:s._online,model:s._nsPanelModel});a&&typeof a=="object"&&"error"in a?this.setState({error:String(a.error),processingPanel:null}):(await this.refreshPanels(),this.setState({processingPanel:null}))}catch(a){this.setState({error:String(a),processingPanel:null})}})}async handleCreateScript(s){this.setState({processingPanel:s._name});try{const a=await this.props.oContext.socket.sendTo(`${this.adapterName}.${this.instance}`,"createScript",{name:s._name,topic:s._topic});a&&typeof a=="object"&&"error"in a?this.setState({error:String(a.error),processingPanel:null}):(await this.refreshPanels(),this.setState({processingPanel:null}))}catch(a){this.setState({error:String(a),processingPanel:null})}}async handleOpenTasmotaConsole(s){try{const a=await this.props.oContext.socket.sendTo(`${this.adapterName}.${this.instance}`,"openTasmotaConsole",{ip:s._ip});a&&typeof a=="object"&&"openUrl"in a&&window.open(a.openUrl,"_blank")}catch(a){this.setState({error:String(a)})}}isPanelUpdateable(s){const a=this.props.data,n=s._ip&&/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/.test(s._ip),i=s._topic&&/^[a-zA-Z][\w/]+$/.test(s._topic),r=a.mqttPort&&a.mqttUsername&&a.mqttPassword,o=a.mqttServer?a.internalServerIp&&/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/.test(a.internalServerIp)&&a.internalServerIp!=="127.0.0.1":a.mqttIp;return!!(n&&i&&r&&o&&s._online!=="no"&&!s._flashing)}getPanelCardStyle(s){console.log(`[Maintain] themeType: ${this.props.themeType}, themeName: ${this.props.themeName}`);const a=this.props.themeName==="dark";return this.state.alive?s._flashing?{backgroundColor:a?U[900]:U[100],borderColor:a?U[700]:U[400],buttonTasmotaColor:"primary",buttonTftColor:"primary",buttonScriptColor:"primary"}:s._online==="no"?{backgroundColor:a?G[900]:G[100],borderColor:G[700],buttonTasmotaColor:"primary",buttonTftColor:"primary",buttonScriptColor:"primary"}:s._check?{backgroundColor:a?J[900]:J[100],borderColor:J[700],buttonTasmotaColor:s._check_tasmota?R[600]:R[200],buttonTftColor:s._check_tft?R[600]:R[200],buttonScriptColor:s._check_script?R[600]:R[200]}:{backgroundColor:a?H[900]:H[100],borderColor:H[700],buttonTasmotaColor:"primary",buttonTftColor:"primary",buttonScriptColor:"primary"}:{backgroundColor:a?O[800]:O[300],borderColor:a?O[700]:O[400],buttonTasmotaColor:"primary",buttonTftColor:"primary",buttonScriptColor:"primary"}}renderItem(s,a,n){const{panels:i,error:r,processingPanel:o}=this.state,d=this.confirmDialog;return e.jsxs(t.Box,{sx:{p:2},children:[this.props.data.useBetaTFT&&e.jsx(t.Alert,{severity:"warning",sx:{mb:2},children:this.getText("useBetaVersionText")}),e.jsx(t.Box,{sx:{mb:2},children:e.jsx(t.Button,{variant:"text",color:"primary",href:"https://github.com/ticaki/ioBroker.nspanel-lovelace-ui/wiki/Adapter-Installation",target:"_blank",sx:{color:"red"},children:this.getText("openLinkAdapterInsatllation")})}),r&&e.jsx(t.Alert,{severity:"error",sx:{mb:2},onClose:()=>this.setState({error:null}),children:r}),e.jsx(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:i.map((h,l)=>{const c=this.getPanelCardStyle(h);return e.jsxs(t.Box,{sx:{width:"fit-content",maxWidth:"100%",minWidth:320,border:3,borderColor:c.borderColor,backgroundColor:c.backgroundColor,opacity:this.state.alive?1:.6,p:2,borderRadius:1},children:[e.jsx(t.Typography,{variant:"h6",sx:{fontWeight:h._check?"bold":"normal",mb:2},children:h._Headline}),e.jsxs(t.Box,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[e.jsxs(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:[e.jsx(t.TextField,{label:this.getText("vTasmota"),value:h._tasmotaVersion,slotProps:{input:{readOnly:!0}},size:"small",sx:{flex:"1 1 250px",minWidth:200,maxWidth:300}}),e.jsx(t.Button,{variant:"contained",onClick:()=>this.handleTasmotaUpdate(h),disabled:!this.isPanelUpdateable(h)||o===h._name||!this.state.alive,size:"small",sx:{flex:"0 0 auto",minWidth:200,...c.buttonTasmotaColor!=="primary"&&{backgroundColor:c.buttonTasmotaColor,"&:hover":{backgroundColor:c.buttonTasmotaColor,filter:"brightness(0.9)"}}},children:o===h._name?e.jsx(t.CircularProgress,{size:20}):this.getText("tasmotaUpdate")})]}),e.jsxs(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:[e.jsx(t.TextField,{label:this.getText("vTFT"),value:h._tftVersion,slotProps:{input:{readOnly:!0}},size:"small",sx:{flex:"1 1 250px",minWidth:200,maxWidth:300}}),e.jsx(t.Button,{variant:"contained",onClick:()=>this.handleTftInstall(h),disabled:h._online==="no"||h._flashing||!h._ip||o===h._name||!this.state.alive,size:"small",sx:{flex:"0 0 auto",minWidth:200,...c.buttonTftColor!=="primary"&&{backgroundColor:c.buttonTftColor,"&:hover":{backgroundColor:c.buttonTftColor,filter:"brightness(0.9)"}}},children:o===h._name?e.jsx(t.CircularProgress,{size:20}):this.getText("tftInstallSendToMQTT")})]}),e.jsxs(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:[e.jsx(t.TextField,{label:this.getText("vScript"),value:h._ScriptVersion,slotProps:{input:{readOnly:!0}},size:"small",sx:{flex:"1 1 250px",minWidth:200,maxWidth:300}}),e.jsx(t.Button,{variant:"contained",onClick:()=>this.handleCreateScript(h),disabled:!h._name||!h._topic||o===h._name||!this.state.alive,size:"small",sx:{flex:"0 0 auto",minWidth:200,...c.buttonScriptColor!=="primary"&&{backgroundColor:c.buttonScriptColor,"&:hover":{backgroundColor:c.buttonScriptColor,filter:"brightness(0.9)"}}},children:o===h._name?e.jsx(t.CircularProgress,{size:20}):this.getText("createScript")})]}),e.jsx(t.Button,{variant:"contained",fullWidth:!0,onClick:()=>this.handleOpenTasmotaConsole(h),disabled:!h._ip||!this.state.alive,size:"small",sx:{mt:1},children:this.getText("openTasmotaConsole")})]})]},h._id||l)})}),d&&e.jsxs(t.Dialog,{open:d.open,onClose:()=>this.closeConfirmDialog(),children:[e.jsx(t.DialogTitle,{children:d.title}),e.jsx(t.DialogContent,{children:e.jsx(t.DialogContentText,{sx:{whiteSpace:"pre-line"},children:d.text})}),e.jsxs(t.DialogActions,{children:[e.jsx(t.Button,{onClick:()=>this.closeConfirmDialog(),children:this.getText("Cancel1")}),e.jsx(t.Button,{onClick:()=>{d.onConfirm&&d.onConfirm()},variant:"contained",color:"primary",children:this.getText("Updating")})]})]})]})}}class te extends B.Component{constructor(s){super(s),this.state={showPassword:!1}}handleToggleVisibility=()=>{this.setState(s=>({showPassword:!s.showPassword}))};handleChange=s=>{this.props.onChange(s.target.value)};render(){const{showPassword:s}=this.state,{label:a,value:n,disabled:i=!1,error:r=!1,helperText:o="",placeholder:d="",fullWidth:h=!1,size:l="small"}=this.props;return e.jsx(t.TextField,{fullWidth:h,label:a,type:s?"text":"password",value:n,onChange:this.handleChange,disabled:i,error:r,helperText:o,placeholder:d,size:l,slotProps:{input:{endAdornment:e.jsx(t.InputAdornment,{position:"end",children:e.jsx(t.IconButton,{onClick:this.handleToggleVisibility,disabled:i,edge:"end",size:"small",children:s?e.jsx($.VisibilityOff,{}):e.jsx($.Visibility,{})})})}}})}}class Me extends D.ConfigGeneric{pagesRetryTimeout;instance=this.props.oContext.instance??"0";adapterName=this.props.oContext.adapterName;constructor(s){super(s),this.state={...this.state,alive:!1}}componentWillUnmount(){this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout),this.props.oContext.socket.unsubscribeState(`system.adapter.${this.adapterName}.${this.instance}.alive`,this.onAliveChanged)}async componentDidMount(){super.componentDidMount();const s=`system.adapter.${this.adapterName}.${this.instance}.alive`;try{const a=await this.props.oContext.socket.getState(s),n=!!(a!=null&&a.val);this.setState({alive:n}),await this.props.oContext.socket.subscribeState(s,this.onAliveChanged)}catch(a){console.error("[PageMQTTSetting] Failed to get alive state or subscribe:",a),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&this.setState({alive:i})};handleCheckboxChange=s=>a=>{this.onChange(s,a.target.checked)};handleSelectStringChange=s=>a=>{this.onChange(s,a.target.value)};handleSelectNumberChange=s=>a=>{this.onChange(s,a.target.value)};handleTextChange=s=>a=>{this.onChange(s,a.target.value)};validateServicePin=s=>s===""||/^[0-9]+$/.test(s);handleServicePinChange=s=>{const a=s.target.value;this.validateServicePin(a)&&this.onChange("pw1",a)};renderItem(s,a,n){const{alive:i}=this.state,r=this.props.data||{},o={p:2,border:2,borderColor:"divider",borderRadius:1,height:"100%",maxWidth:"50%"};return e.jsxs(t.Box,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(t.Box,{sx:o,children:[e.jsx(t.FormControlLabel,{sx:{mb:0},control:e.jsx(t.Checkbox,{onChange:this.handleCheckboxChange("mqttServer"),checked:r.mqttServer??!1,disabled:!i}),label:this.getText("mqttServer")}),!r.mqttServer&&e.jsx(t.Typography,{variant:"body2",color:"red",sx:{mt:1},children:this.getText("notifyMqttServer")}),e.jsx(t.Button,{variant:"contained",color:"primary",onClick:()=>{},disabled:!i||!r.mqttServer,children:this.getText("getRandomMqttCredentials")})]}),e.jsxs(t.Box,{sx:o,children:[e.jsx(t.TextField,{label:this.getText("mqttIp"),value:r.mqttIp??"",onChange:this.handleTextChange("mqttIp"),disabled:!i||r.mqttServer}),e.jsx(t.TextField,{label:this.getText("mqttPort"),value:r.mqttPort??"",onChange:this.handleTextChange("mqttPort"),disabled:!i||r.mqttServer}),e.jsx(t.TextField,{label:this.getText("mqttUsername"),value:r.mqttUsername??"",onChange:this.handleTextChange("mqttUsername"),disabled:!i||r.mqttServer}),e.jsx(te,{label:this.getText("mqttPassword"),value:r.mqttPassword??"",onChange:d=>this.props.onChange({mqttPassword:d}),placeholder:"••••••••",disabled:!i||r.mqttServer})]}),e.jsxs(t.Box,{sx:o,children:[e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{onChange:this.handleCheckboxChange("useTasmotaAdmin"),checked:r.useTasmotaAdmin??!1,disabled:!i}),label:this.getText("useTasmotaAdmin")}),r.useTasmotaAdmin&&e.jsx(te,{label:this.getText("tasmotaAdminPassword"),value:r.tasmotaAdminPassword,onChange:d=>this.props.onChange({tasmotaAdminPassword:d}),placeholder:"••••••••",disabled:!i})]})]})}}const $e=z(Me);class qe extends D.ConfigGeneric{pagesRetryTimeout;instance=this.props.oContext.instance??"0";adapterName=this.props.oContext.adapterName;constructor(s){super(s),this.state={...this.state,alive:!1,timezoneEntities:[],lastTimezoneLoad:0,showConfirm:!1,processing:!1,error:null,panels:[],showDeleteConfirm:!1,panelToDelete:null,showSuccessConfirm:!1,successMessage:"",pendingPanels:null,panelOnlineStates:{}}}componentWillUnmount(){this.pagesRetryTimeout&&clearTimeout(this.pagesRetryTimeout),this.props.oContext.socket.unsubscribeState(`system.adapter.${this.adapterName}.${this.instance}.alive`,this.onAliveChanged);for(const s of this.props.data.panels||[])this.props.oContext.socket.unsubscribeState(`${this.adapterName}.${this.instance}.panels.${s.id}.info.isOnline`,this.onPanelOnlineChanged)}async componentDidMount(){super.componentDidMount();const s=`system.adapter.${this.adapterName}.${this.instance}.alive`;try{const a=await this.props.oContext.socket.getState(s),n=!!(a!=null&&a.val);this.setState({alive:n}),await this.props.oContext.socket.subscribeState(s,this.onAliveChanged)}catch(a){console.error("[PagePanelOverview] Failed to get alive state or subscribe:",a),this.setState({alive:!1,error:String(a)})}try{for(const a of this.props.data.panels)console.log(`[PagePanelOverview] Subscribing to online state for panel ${a.name} (${a.id})`),await this.props.oContext.socket.subscribeState(`${this.adapterName}.${this.instance}.panels.${a.id}.info.isOnline`,this.onPanelOnlineChanged)}catch(a){console.error("[PagePanelOverview] Failed to subscribe to panel online states:",a)}}onAliveChanged=(s,a)=>{const n=this.state.alive,i=a?!!a.val:!1;n!==i&&this.setState({alive:i,error:i?null:this.getText("adapterNotAlive")})};onPanelOnlineChanged=(s,a)=>{const n=s.match(/\.panels\.([^.]+)\.info\.isOnline$/);if(!n){console.warn("[PagePanelOverview] Could not extract panel ID from state:",s);return}const i=n[1],r=a?!!a.val:!1;console.log(`[PagePanelOverview] Panel ${i} online status changed:`,r),this.setState(o=>({panelOnlineStates:{...o.panelOnlineStates,[i]:r}}))};async loadTimezoneEntities(s=!1){var i,r;if(!this.state.alive)return;const a=Date.now(),n=this.state.lastTimezoneLoad||0;if(!s&&a-n<6e4&&((i=this.state.timezoneEntities)!=null&&i.length)){console.log("[PagePanelOverview] Using cached timezone entities, last load:",new Date(n));return}if(console.log("[PagePanelOverview] Loading timezone entities, forceReload:",s),this.setState({loadingTimezone:!0,error:null}),this.props.oContext.socket){const o=`${this.adapterName}.${this.instance}`,d={ip:(r=this.props.data)==null?void 0:r.internalServerIp};try{const h=new Promise((T,C)=>{setTimeout(()=>C(new Error("sendTo timeout after 2 seconds")),2e3)}),l=this.props.oContext.socket.sendTo(o,"getTimeZones",d),c=await Promise.race([l,h]);let p=[];Array.isArray(c)?p=c:c&&Array.isArray(c.result)&&(p=c.result),console.log("[PagePanelOverview] sendTo successful",{target:o,entities:p}),this.setState({timezoneEntities:p,lastTimezoneLoad:a,loadingTimezone:!1})}catch(h){console.error("[PagePanelOverview] Failed to load timezone entities",{target:o,cmd:"getTimeZones",payload:d,error:h}),this.setState({timezoneEntities:[],loadingTimezone:!1,error:String(h)})}}}handleCheckboxChange=s=>a=>{this.onChange(s,a.target.checked)};handleSelectStringChange=s=>a=>{this.onChange(s,a.target.value)};handleSelectNumberChange=s=>a=>{this.onChange(s,a.target.value)};handleTextChange=s=>a=>{this.onChange(s,a.target.value)};validatePin=s=>s===""||/^[0-9]+$/.test(s);isValidIpInput(s){return s===""?!0:!/^[\d.]*$/.test(s)||s.split(".").length>4?!1:s.split(".").every(n=>{if(n==="")return!0;const i=parseInt(n,10);return!isNaN(i)&&i<=255})}isValidCompleteIp(s){if(s==="127.0.0.1")return!1;if(s==="")return!0;const a=s.split(".");return a.length!==4?!1:a.every(n=>{const i=parseInt(n,10);return!isNaN(i)&&i>=0&&i<=255})}validateTopic(s){return!s||s.length<4?!1:/^[a-zA-Z][\w/]+$/.test(s)}isFormValid(){const s=this.props.data;return!!s._tasmotaIP&&this.isValidCompleteIp(s._tasmotaIP)&&!!s._tasmotaTopic&&this.validateTopic(s._tasmotaTopic)&&!!s._tasmotaName&&s.nsPanelModel!=null&&(!!s.mqttServer||!!s.mqttIp)&&!!s.mqttPort&&!!s.mqttUsername&&!!s.mqttPassword&&(!s.mqttServer||!!s.internalServerIp&&this.isValidCompleteIp(s.internalServerIp))}isPanelAlreadyConfigured(){return(this.props.data.panels||[]).findIndex(a=>a.topic===this.props.data._tasmotaTopic)!==-1}handleInitClick=()=>{this.setState({showConfirm:!0})};handleConfirmClose=()=>{this.setState({showConfirm:!1})};handleConfirmStart=async()=>{console.log("[PagePanelOverview] === INIT START ==="),this.setState({showConfirm:!1,processing:!0,error:null});try{const s={tasmotaName:this.props.data._tasmotaName,tasmotaIP:this.props.data._tasmotaIP,tasmotaTopic:this.props.data._tasmotaTopic,mqttServer:this.props.data.mqttServer,mqttIp:this.props.data.mqttIp,mqttPort:this.props.data.mqttPort,mqttUsername:this.props.data.mqttUsername,mqttPassword:this.props.data.mqttPassword,internalServerIp:this.props.data.internalServerIp,useBetaTFT:this.props.data.useBetaTFT,model:this.props.data.nsPanelModel};console.log("[PagePanelOverview] Sending payload:",s);const a=await this.props.oContext.socket.sendTo(`${this.adapterName}.${this.instance}`,"nsPanelInit",s);if(console.log("[PagePanelOverview] Received result:",a),a&&typeof a=="object"){if("error"in a&&a.error){console.error("[PagePanelOverview] Error from adapter:",a.error);const n=this.getText(String(a.error))||String(a.error);this.setState({processing:!1,error:n});return}if("native"in a&&a.native&&"saveConfig"in a&&a.saveConfig){const n=a.native;if(console.log("[PagePanelOverview] Success! Native data:",n),n.panels&&Array.isArray(n.panels)){const i="result"in a?String(a.result):"sendToNSPanelInitDataSuccess";console.log("[PagePanelOverview] Success message key:",i);const r=this.getText(i)||i;this.setState({processing:!1,showSuccessConfirm:!0,successMessage:r,pendingPanels:n.panels})}else console.error("[PagePanelOverview] No panels in native data"),this.setState({processing:!1,error:"No panels data received"})}else console.error("[PagePanelOverview] Unexpected response structure:",a),this.setState({processing:!1,error:"Unexpected response from adapter"})}else console.error("[PagePanelOverview] Invalid result object:",a),this.setState({processing:!1,error:"Invalid response from adapter"})}catch(s){console.error("[PagePanelOverview] Init failed with exception:",s),this.setState({processing:!1,error:String(s)})}};handlePinChange=s=>a=>{const n=a.target.value;this.validatePin(n)&&this.onChange(s,n)};handleIpChange=s=>a=>{const n=a.target.value;this.isValidIpInput(n)&&(this.onChange(s,n),this.checkValidation(s,n))};checkValidation(s,a){const i={...this.props.data||{},[s]:a};i.internalServerIp&&!this.isValidCompleteIp(i.internalServerIp)?this.props.onError("internalServerIp",this.getText("mustBeIp")):this.props.onError("internalServerIp"),i._tasmotaIP&&!this.isValidCompleteIp(i._tasmotaIP)?this.props.onError("_tasmotaIP",this.getText("mustBeIp")):this.props.onError("_tasmotaIP"),i._tasmotaTopic&&!this.validateTopic(i._tasmotaTopic)?this.props.onError("_tasmotaTopic",this.getText("invalidTopic")):this.props.onError("_tasmotaTopic")}async handleOpenTasmotaConsole(s){try{const a=await this.props.oContext.socket.sendTo(`${this.adapterName}.${this.instance??"0"}`,"openTasmotaConsole",{ip:s.ip});a&&typeof a=="object"&&"openUrl"in a&&window.open(a.openUrl,"_blank")}catch(a){this.setState({error:String(a)})}}handleEditPanel=s=>{console.log("Editing panel:",s),this.state.alive&&(this.props.data._tasmotaIP=s.ip||"",this.props.data._tasmotaName=s.name||"",this.props.data._tasmotaTopic=s.topic||"",this.props.data.nsPanelModel=s.model||"eu",this.forceUpdate())};handleDeleteClick=s=>{this.setState({showDeleteConfirm:!0,panelToDelete:s})};handleDeleteClose=()=>{this.setState({showDeleteConfirm:!1,panelToDelete:null})};handleDeleteConfirm=()=>{const{panelToDelete:s}=this.state;if(!s)return;console.log("[PagePanelOverview] Deleting panel:",s);const n=(this.props.data.panels||[]).filter(i=>i.id!==s.id);this.onChange("panels",n),this.setState({showDeleteConfirm:!1,panelToDelete:null})};handleSuccessClose=()=>{console.log("[PagePanelOverview] Success dialog cancelled"),this.setState({showSuccessConfirm:!1,successMessage:"",pendingPanels:null})};handleSuccessSave=async()=>{console.log("[PagePanelOverview] Saving config after success");const{pendingPanels:s}=this.state;s&&(await this.onChange("panels",s),this.props.data._tasmotaIP="",this.props.data._tasmotaName="",this.props.data._tasmotaTopic="",this.setState({showSuccessConfirm:!1,successMessage:"",pendingPanels:null}),this.forceUpdate(),console.log("[PagePanelOverview] Config saved successfully"))};renderItem(s,a,n){const i=this.props.data||{},r=this.isPanelAlreadyConfigured(),o=i.panels||[],{alive:d,panelOnlineStates:h,loadingTimezone:l,error:c,showConfirm:p,showDeleteConfirm:T,showSuccessConfirm:C,panelToDelete:w,successMessage:v,timezoneEntities:g,processing:j}=this.state,b=i.nsPanelModel??"eu",N={p:2,border:2,borderColor:"divider",borderRadius:1};return e.jsxs(t.Box,{sx:{display:"flex",flexDirection:"column",gap:2},children:[this.props.data.useBetaTFT&&e.jsx(t.Alert,{severity:"warning",sx:{mb:2},children:this.getText("useBetaVersionText")}),e.jsx(t.Box,{sx:{mb:2},children:e.jsx(t.Button,{variant:"text",color:"primary",href:"https://github.com/ticaki/ioBroker.nspanel-lovelace-ui/wiki/Adapter-Installation",target:"_blank",sx:{color:"red"},children:this.getText("openLinkAdapterInsatllation")})}),e.jsxs(t.Box,{component:"fieldset",sx:N,children:[e.jsx(t.Typography,{component:"legend",variant:"h6",children:this.getText("nsPanelInitLabel")}),i.mqttServer&&e.jsx(t.TextField,{sx:{m:1,minWidth:200},size:"small",disabled:!d,variant:"standard",label:this.getText("internalServerIp"),value:i.internalServerIp??"",onChange:this.handleIpChange("internalServerIp"),error:!!i.internalServerIp&&!this.isValidCompleteIp(i.internalServerIp),helperText:i.internalServerIp&&!this.isValidCompleteIp(i.internalServerIp)?this.getText("mustBeIp"):""}),e.jsx(t.TextField,{sx:{m:1,minWidth:200},variant:"standard",size:"small",disabled:!d,label:this.getText("ipFromPanel"),value:i._tasmotaIP??"",onChange:this.handleIpChange("_tasmotaIP"),error:!!i._tasmotaIP&&!this.isValidCompleteIp(i._tasmotaIP),helperText:i._tasmotaIP&&!this.isValidCompleteIp(i._tasmotaIP)?this.getText("mustBeIp"):""}),e.jsx(t.TextField,{sx:{m:1,minWidth:200},size:"small",disabled:!d,variant:"standard",label:this.getText("panelName"),value:i._tasmotaName??"",onChange:this.handleTextChange("_tasmotaName")}),e.jsx(t.TextField,{sx:{m:1,minWidth:200},size:"small",disabled:!d,variant:"standard",label:this.getText("panelTopic"),value:i._tasmotaTopic??"",onChange:this.handleTextChange("_tasmotaTopic"),error:!!i._tasmotaTopic&&!this.validateTopic(i._tasmotaTopic)}),e.jsxs(t.FormControl,{sx:{m:1,minWidth:200},size:"small",disabled:!d,variant:"standard",children:[e.jsx(t.InputLabel,{id:"panelmodel-label",children:this.getText("nsPanelModel")}),e.jsxs(t.Select,{labelId:"panelmodel-label",id:"panelmodel-select",label:this.getText("nsPanelModel"),value:b,onChange:this.handleSelectStringChange("nsPanelModel"),children:[e.jsx(t.MenuItem,{value:"eu",children:this.getText("eu-Version")}),e.jsx(t.MenuItem,{value:"us-l",children:this.getText("us-l-Version")}),e.jsx(t.MenuItem,{value:"us-p",children:this.getText("us-p-Version")})]})]}),e.jsxs(t.FormControl,{sx:{m:1,minWidth:200},size:"small",disabled:!d||l,variant:"standard",children:[e.jsx(t.InputLabel,{id:"timezone-label",children:this.getText("timezone")}),e.jsxs(t.Select,{labelId:"timezone-label",id:"timezone-select",value:i.timezone??"",label:this.getText("timezone"),onOpen:()=>{this.loadTimezoneEntities(!0)},onChange:this.handleSelectStringChange("timezone"),children:[l&&e.jsx(t.MenuItem,{disabled:!0,value:"",children:e.jsx(t.CircularProgress,{size:16})}),(g||[]).map(x=>e.jsx(t.MenuItem,{value:x.value,children:x.label},x.value||x.label))]})]})]}),c&&e.jsx(t.Alert,{severity:"error",onClose:()=>this.setState({error:null}),sx:{mt:2},children:c}),e.jsx(t.Button,{variant:"contained",fullWidth:!0,onClick:this.handleInitClick,disabled:!d||!this.isFormValid()||j,sx:{mt:2},children:j?e.jsx(t.CircularProgress,{size:24}):r?this.getText("nsPanelUpdate"):this.getText("nsPanelInit")}),e.jsx(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:o.map((x,q)=>e.jsxs(t.Box,{sx:{width:"fit-content",maxWidth:"100%",minWidth:320,border:3,opacity:d?1:.6,p:2,borderRadius:1},children:[e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",mb:2,gap:1},children:[e.jsx(xe,{sx:{fontSize:20,color:h[x.id||""]===!0?H[500]:h[x.id||""]===!1?G[500]:O[400],ml:-.5},titleAccess:h[x.id||""]===!0?"Online":h[x.id||""]===!1?"Offline":"Unknown"}),e.jsx(t.Typography,{variant:"h6",sx:{flex:1},children:x.name}),e.jsx(t.IconButton,{size:"small",color:"primary",onClick:()=>this.handleEditPanel(x),disabled:!d||!h[x.id||""],title:this.getText("editPanel"),children:e.jsx(ge,{})}),e.jsx(t.IconButton,{size:"small",color:"error",onClick:()=>this.handleDeleteClick(x),disabled:!d||!h[x.id||""],title:this.getText("deletePanel"),children:e.jsx(ue,{})})]}),e.jsxs(t.Box,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[e.jsx(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:e.jsx(t.TextField,{label:this.getText("macAdressOfPanel"),value:x.id,slotProps:{input:{readOnly:!0}},size:"small",sx:{flex:"1 1 250px",minWidth:200,maxWidth:300}})}),e.jsx(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:e.jsx(t.TextField,{label:this.getText("ipFromPanel"),value:x.ip,slotProps:{input:{readOnly:!0}},size:"small",sx:{flex:"1 1 250px",minWidth:200,maxWidth:300}})}),e.jsx(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:e.jsx(t.TextField,{label:this.getText("panelTopic"),value:x.topic,slotProps:{input:{readOnly:!0}},size:"small",sx:{flex:"1 1 250px",minWidth:200,maxWidth:300}})}),e.jsx(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:e.jsx(t.TextField,{label:this.getText("panelModel"),value:x.model,slotProps:{input:{readOnly:!0}},size:"small",sx:{flex:"1 1 250px",minWidth:200,maxWidth:300}})}),e.jsx(t.Button,{variant:"contained",fullWidth:!0,onClick:()=>this.handleOpenTasmotaConsole(x),disabled:!x.ip||!d||h[x.id||""]===!1,size:"small",sx:{mt:1},children:this.getText("openTasmotaConsole")})]})]},x.id||q))}),e.jsxs(t.Dialog,{open:p,onClose:this.handleConfirmClose,children:[e.jsx(t.DialogTitle,{children:r?this.getText("nsPanelUpdate"):this.getText("nsPanelInit")}),e.jsx(t.DialogContent,{children:e.jsx(t.DialogContentText,{children:r?this.getText("NSPanel_configuration_update_text"):this.getText("NSPanel_configuration_text")})}),e.jsxs(t.DialogActions,{children:[e.jsx(t.Button,{onClick:this.handleConfirmClose,children:this.getText("Cancel")}),e.jsx(t.Button,{onClick:this.handleConfirmStart,variant:"contained",autoFocus:!0,children:this.getText("Start")})]})]}),e.jsxs(t.Dialog,{open:T,onClose:this.handleDeleteClose,children:[e.jsx(t.DialogTitle,{children:this.getText("deletePanel")}),e.jsx(t.DialogContent,{children:e.jsx(t.DialogContentText,{children:this.getText("deletePanelConfirmText").replace("%s",(w==null?void 0:w.name)||"")})}),e.jsxs(t.DialogActions,{children:[e.jsx(t.Button,{onClick:this.handleDeleteClose,children:this.getText("Cancel")}),e.jsx(t.Button,{onClick:this.handleDeleteConfirm,variant:"contained",color:"error",autoFocus:!0,children:this.getText("Delete")})]})]}),e.jsxs(t.Dialog,{open:C,onClose:this.handleSuccessClose,children:[e.jsx(t.DialogTitle,{children:this.getText("Success")}),e.jsx(t.DialogContent,{children:e.jsx(t.DialogContentText,{children:v})}),e.jsxs(t.DialogActions,{children:[e.jsx(t.Button,{onClick:this.handleSuccessClose,children:this.getText("Cancel")}),e.jsx(t.Button,{onClick:this.handleSuccessSave,variant:"contained",color:"primary",autoFocus:!0,children:this.getText("Save")})]})]})]})}}const Le=z(qe),et={NavigationView:le,IconSelect:se,IconOverview:re,PageConfigManager:we,ScreensaverPage:Fe,PageGlobalSettings:De,TabMaintain:Be,PageMQTTSetting:$e,PagePanelOverview:Le};export{et as default};
